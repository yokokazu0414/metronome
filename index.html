<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Metronome — iOS Safe</title>
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0e1116;color:#e6edf3;}
    .wrap{max-width:720px;margin:40px auto;padding:24px}
    h1{font-size:22px;margin:0 0 16px}
    .card{background:#161b22;border:1px solid #30363d;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{opacity:.9}
    input[type="number"],input[type="range"],select,button{border-radius:12px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;padding:10px 12px;font-size:16px}
    input[type="range"]{width:200px}
    button.primary{background:#1f6feb;border-color:#1f6feb}
    button:disabled{opacity:.5}
    .hint{opacity:.8;font-size:13px;margin-top:8px}

    /* iOS audio unlock overlay */
    .unlock{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:9999}
    .unlock button{font-size:18px;padding:14px 18px;border-radius:14px;background:#238636;border:1px solid #2ea043;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .hidden{display:none}
  </style>
</head>
<body>
  <div id="unlock" class="unlock"><button id="unlockBtn">Audioを有効化（タップ）</button></div>

  <div class="wrap">
    <h1>Metronome — iOS Safe</h1>
    <div class="card">
      <div class="row" style="margin-bottom:12px">
        <label>BPM</label>
        <input id="bpm" type="number" min="20" max="300" step="1" value="120" />
        <input id="bpmRange" type="range" min="20" max="300" value="120" />
        <label>拍子</label>
        <select id="beats">
          <option value="2">2/4</option>
          <option value="3">3/4</option>
          <option value="4" selected>4/4</option>
          <option value="6">6/8</option>
        </select>
        <label>音量</label>
        <input id="vol" type="range" min="0" max="1" value="0.6" step="0.01" />
      </div>
      <div class="row">
        <button id="start" class="primary">Start</button>
        <button id="stop">Stop</button>
      </div>
      <div class="hint">iPhoneでは最初に「Audioを有効化」をタップしてください。ホーム画面に追加すると全画面で使えます。</div>
    </div>
  </div>

<script>
(function(){
  // ====== Audio bootstrap (iOS 安全) ======
  const AC = window.AudioContext || window.webkitAudioContext;
  let ctx = null, master = null;

  function ensureAudio(){
    if (!ctx) {
      ctx = new AC({ latencyHint: 'interactive' });
      master = ctx.createGain();
      master.gain.value = parseFloat(document.getElementById('vol').value || '0.6');
      master.connect(ctx.destination);
      // 無音1サンプルを再生してiOSを確実に解放
      const b = ctx.createBuffer(1, 1, ctx.sampleRate);
      const s = ctx.createBufferSource(); s.buffer = b; s.connect(master); s.start(0);
    }
    if (ctx.state === 'suspended') ctx.resume();
  }

  function showUnlock(v){
    document.getElementById('unlock').classList.toggle('hidden', !!v);
  }

  const unlockBtn = document.getElementById('unlockBtn');
  const unlockOnce = () => { ensureAudio(); showUnlock(true); remAll(); };
  const evts = ['touchstart','pointerup','click'];
  function remAll(){ evts.forEach(e=>window.removeEventListener(e, unlockOnce, true)); }
  evts.forEach(e=>window.addEventListener(e, unlockOnce, { capture:true }));
  unlockBtn.addEventListener('click', unlockOnce, { once:true });

  // ====== Click sound buffers ======
  let clickHi = null, clickLo = null;
  function makeClickBuffer(freq = 2000, dur = 0.02){
    const len = Math.max(1, Math.floor((ctx ? ctx.sampleRate : 48000) * dur));
    const buffer = (ctx || { createBuffer: (ch, l, sr) => new (window.OfflineAudioContext||window.webkitOfflineAudioContext)(1, l, sr).createBuffer(ch, l, sr) }).createBuffer(1, len, (ctx ? ctx.sampleRate : 48000));
    const data = buffer.getChannelData(0);
    for (let i=0;i<len;i++){
      const t = i/ (ctx ? ctx.sampleRate : 48000);
      // 短い指数フェードのサイン + 少量ノイズでクリック感
      const env = Math.exp(-40*t);
      const sine = Math.sin(2*Math.PI*freq*t);
      const noise = (Math.random()*2-1)*0.1;
      data[i] = (sine*0.9 + noise)*env;
    }
    return buffer;
  }

  function prepareBuffers(){
    if (!ctx) ensureAudio();
    clickHi = makeClickBuffer(2400, 0.02);
    clickLo = makeClickBuffer(1600, 0.02);
  }

  function playClick(accent){
    const src = ctx.createBufferSource();
    src.buffer = accent ? clickHi : clickLo;
    const g = ctx.createGain();
    g.gain.value = accent ? 0.9 : 0.6;
    src.connect(g); g.connect(master);
    src.start();
  }

  // ====== Scheduler ======
  let nextNoteTime = 0; // seconds (ctx time)
  let currentBeat = 0;
  let scheduleTimer = null;
  const lookahead = 25/1000; // 25ms
  const scheduleAheadTime = 0.1; // 100ms

  function nextNote(){
    const bpm = clamp(parseInt(document.getElementById('bpm').value, 10) || 120, 20, 300);
    const secPerBeat = 60.0 / bpm;
    nextNoteTime += secPerBeat;
    currentBeat = (currentBeat + 1) % getBeats();
  }

  function getBeats(){ return parseInt(document.getElementById('beats').value, 10) || 4; }

  function scheduler(){
    while (nextNoteTime < ctx.currentTime + scheduleAheadTime){
      const when = nextNoteTime;
      const accent = (currentBeat === 0);
      scheduleClick(when, accent);
      nextNote();
    }
  }

  function scheduleClick(when, accent){
    const src = ctx.createBufferSource();
    src.buffer = accent ? clickHi : clickLo;
    const g = ctx.createGain();
    g.gain.value = accent ? 0.9 : 0.6;
    src.connect(g); g.connect(master);
    src.start(when);
  }

  function start(){
    ensureAudio();
    prepareBuffers();
    const bpm = clamp(parseInt(document.getElementById('bpm').value, 10) || 120, 20, 300);
    const secPerBeat = 60.0 / bpm;
    nextNoteTime = ctx.currentTime + 0.05; // 50ms 後に最初の音
    currentBeat = getBeats() - 1; // 最初はアクセントから
    if (scheduleTimer) clearInterval(scheduleTimer);
    scheduleTimer = setInterval(scheduler, lookahead * 1000);
    document.getElementById('start').disabled = true;
    document.getElementById('stop').disabled = false;
  }

  function stop(){
    if (scheduleTimer) clearInterval(scheduleTimer);
    scheduleTimer = null;
    document.getElementById('start').disabled = false;
    document.getElementById('stop').disabled = true;
  }

  function clamp(v, lo, hi){ return Math.min(hi, Math.max(lo, v)); }

  // ====== UI wiring ======
  const bpm = document.getElementById('bpm');
  const bpmRange = document.getElementById('bpmRange');
  bpm.addEventListener('input', () => bpmRange.value = bpm.value);
  bpmRange.addEventListener('input', () => bpm.value = bpmRange.value);
  document.getElementById('vol').addEventListener('input', (e)=>{ if(master) master.gain.value = parseFloat(e.target.value); });
  document.getElementById('start').addEventListener('click', ()=>{ ensureAudio(); start(); });
  document.getElementById('stop').addEventListener('click', stop);

  // 画面非表示時は安全に停止（モバイルの省電力対策）
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden) stop(); });

})();
</script>
</body>
</html>
