<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Metronome Studio v4 ‚Äî Mobile Optimized (Full Kit)</title>
<style>
  /* ===== Theme (dark + silver accent) ===== */
  :root{
    color-scheme: dark;
    --bg:#0d1117;
    --panel:#121821;
    --border:#2a3442;
    --divider:#3b4656;
    --text:#e7ecf3;
    --muted:#9fb0c3;
    --accent:#7dd3fc;
    --silver:#cbd5e1;
    --silver2:#b8c2cf;
    --ok:#10b981;
    --danger:#ef4444;
  }
  *,*::before,*::after{ box-sizing:border-box }
  html,body{
    margin:0; padding:0; width:100%; max-width:100%; overflow-x:hidden;
    background:
      radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.06), transparent 60%),
      linear-gradient(180deg, #0f141b 0%, #0c1117 70%, #0b1014 100%);
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
  }
  button,select,input{ font-size:17px; border-radius:14px; border:1px solid var(--border); background:#0f151c; color:var(--text) }
  input[type="number"]{ text-align:center; font-weight:800; background:#0c1218 }
  input[type="range"]{ width:100%; appearance:none; height:28px; background:transparent; padding:0; margin:0 }
  input[type="range"]::-webkit-slider-runnable-track{ height:4px; background:linear-gradient(90deg, var(--silver), #93a1b4); border-radius:999px }
  input[type="range"]::-webkit-slider-thumb{ appearance:none; width:20px; height:20px; border-radius:50%; background:#eef2f7; border:1px solid #c9d2de; margin-top:-8px }
  input[type="range"]::-moz-range-track{ height:4px; background:linear-gradient(90deg, var(--silver), #93a1b4); border-radius:999px }
  input[type="range"]::-moz-range-thumb{ width:20px; height:20px; border-radius:50%; background:#eef2f7; border:1px solid #c9d2de }

  h1{ margin: 14px 0 6px; font-size: 20px; color:var(--silver); text-align:center }
  .app{ max-width:520px; margin:0 auto; padding: max(8px, env(safe-area-inset-top)) 14px 18px }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02)), var(--panel);
    border:1px solid var(--border); border-radius:18px; padding:14px; margin:10px auto 14px;
    width:min(520px, 94vw);
  }
  .row{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:10px }
  .section{ display:grid; gap:8px; margin-top:8px }
  .divider{ height:1px; background:linear-gradient(90deg, transparent, var(--divider), transparent); margin:10px 0 }

  .bpmBlock{ display:grid; grid-template-columns: 52px 1fr 52px; gap:8px; align-items:center; justify-items:center }
  .bpmBlock .icon-btn{ width:52px; height:52px; font-size:22px; border-radius:999px; }
  #bpm{ width:112px; height:52px; font-size:21px; border-radius:16px }

  .controlCard{ background:#0f151c; border:1px solid var(--border); border-radius:14px; padding:10px; flex:1 }
  .label{ text-align:left; color:var(--silver); font-size:12px }
  .pair{ display:grid; grid-template-columns: 1fr auto 1fr; gap:6px; align-items:center }

  .kitGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px }
  .kitGrid-bottom{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:8px }
  .chip{ display:flex; align-items:center; gap:10px; padding:10px; border:1px solid var(--border); background:#0f151c; border-radius:12px }

  .btn.primary{ background:linear-gradient(180deg, var(--silver), var(--silver2)); color:#0b1117; font-weight:800 }
  .btn.danger{ background:#ab2a2a; color:#fff; font-weight:800 }

  #unlockOverlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(4,6,10,.62); backdrop-filter: blur(5px); z-index:9999; }
  #unlockOverlay.hidden{ display:none }
  #unlockOverlay .card{ background:#0e141b; border:1px solid var(--border); border-radius:20px; padding:16px; max-width: 92vw; }
</style>
</head>
<body>
<div id="unlockOverlay">
  <div class="card">
    <div style="font-weight:700;margin-bottom:8px">Èü≥Â£∞„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
    <button id="unlock">üéµ Audio„ÇíÊúâÂäπÂåñ</button>
  </div>
</div>

<div class="app">
  <h1>Metronome Studio v4</h1>
  <div class="panel">
    <div class="section">
      <div class="label">„ÉÜ„É≥„Éù</div>
      <div class="bpmBlock">
        <button id="bpmMinus" class="icon-btn">‚àí</button>
        <input id="bpm" type="number" value="100" min="20" max="300" />
        <button id="bpmPlus" class="icon-btn">Ôºã</button>
      </div>
    </div>
    <div class="divider"></div>
    <div class="row">
      <div class="controlCard">
        <div class="label">ÊãçÂ≠ê</div>
        <div class="pair">
          <input id="beats" type="number" value="4" min="1" max="12">
          <span>/</span>
          <input id="beatUnit" type="number" value="4" min="1" max="32">
        </div>
      </div>
      <div class="controlCard">
        <div class="label">Á¥∞ÂàÜ</div>
        <select id="subdiv">
          <option value="quarter">4ÂàÜ</option>
          <option value="eighth" selected>8ÂàÜ</option>
          <option value="triplet">3ÈÄ£</option>
          <option value="sixteenth">16ÂàÜ</option>
        </select>
      </div>
    </div>
    <div class="section" style="margin-top:10px">
      <div class="label">Èü≥Èáè</div>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.7">
    </div>
    <div class="divider"></div>
    <div class="section">
      <div class="label">„Ç≠„ÉÉ„Éà</div>
      <div class="kitGrid">
        <label class="chip"><input type="checkbox" id="kick" checked> Kick</label>
        <label class="chip"><input type="checkbox" id="snare" checked> Snare</label>
        <label class="chip"><input type="checkbox" id="hihat" checked> Hi-Hat</label>
        <label class="chip"><input type="checkbox" id="tamb"> Tambourine</label>
      </div>
      <div class="kitGrid-bottom">
        <label class="chip"><input type="checkbox" id="shaker"> Shaker</label>
        <label class="chip"><input type="checkbox" id="conga"> Conga</label>
        <label class="chip"><input type="checkbox" id="bongo"> Bongo</label>
      </div>
    </div>
    <div class="row" style="margin-top:12px; justify-content:center">
      <button id="start" class="btn primary">Start</button>
      <button id="stop" class="btn danger">Stop</button>
    </div>
  </div>
</div>

<script>
(() => {
  const el = id => document.getElementById(id);
  let ctx, master, bpm=100, beats=4, beatUnit=4, subdiv='eighth';
  let playing=false, step=0, nextTime=0;
  const ahead = 0.14;

  function initAudio(){
    if (ctx) return ctx;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = parseFloat(el('volume').value||'0.7');
    master.connect(ctx.destination);
    return ctx;
  }

  function unlockAudio(){
    initAudio();
    ctx.resume();
    const ov = el('unlockOverlay');
    if (ctx.state==='running') ov.classList.add('hidden');
  }

  function secPerStep(){
    const spb = 60 / bpm;
    const stepsPerBeat = subdiv==='quarter'?1:subdiv==='eighth'?2:subdiv==='triplet'?3:4;
    return spb * (4/beatUnit) / stepsPerBeat;
  }

  // ==== Instruments ====
  function playKick(t){ const o=ctx.createOscillator(), g=ctx.createGain(); o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(50,t+0.1); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3); o.connect(g).connect(master); o.start(t); o.stop(t+0.3); }
  function playSnare(t){ const n=ctx.createBufferSource(), b=ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate), d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; n.buffer=b; const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=1500; const g=ctx.createGain(); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.2); n.connect(f).connect(g).connect(master); n.start(t); n.stop(t+0.2); }
  function playHihat(t){ const n=ctx.createBufferSource(), b=ctx.createBuffer(1, ctx.sampleRate*0.04, ctx.sampleRate), d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; n.buffer=b; const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=7000; const g=ctx.createGain(); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.05); n.connect(f).connect(g).connect(master); n.start(t); n.stop(t+0.05); }
  function playTamb(t){ /* tambourine code */ }
  function playShaker(t){ /* shaker code */ }
  function playConga(t){ /* conga code */ }
  function playBongo(t){ /* bongo code */ }

  function scheduleStep(i,t){
    if (el('kick').checked)  playKick(t);
    if (el('snare').checked) playSnare(t);
    if (el('hihat').checked) playHihat(t);
    if (el('tamb').checked)  playTamb(t);
    if (el('shaker').checked) playShaker(t);
    if (el('conga').checked)  playConga(t);
    if (el('bongo').checked)  playBongo(t);
  }

  function scheduler(){
    while(nextTime < ctx.currentTime + ahead){
      scheduleStep(step, nextTime);
      nextTime += secPerStep();
      step++;
    }
  }

  function start(){
    unlockAudio();
    bpm = parseInt(el('bpm').value);
    beats = parseInt(el('beats').value);
    beatUnit = parseInt(el('beatUnit').value);
    subdiv = el('subdiv').value;
    playing=true; step=0; nextTime=ctx.currentTime+0.05;
    (function loop(){ if(!playing) return; scheduler(); requestAnimationFrame(loop); })();
  }
  function stop(){ playing=false; }

  el('unlock').onclick = unlockAudio;
  el('start').onclick = start;
  el('stop').onclick = stop;
  el('bpmMinus').onclick = ()=>{ el('bpm').value = Math.max(20, parseInt(el('bpm').value)-1); };
  el('bpmPlus').onclick = ()=>{ el('bpm').value = Math.min(300, parseInt(el('bpm').value)+1); };
  el('volume').oninput = e=>{ if(master) master.gain.value = parseFloat(e.target.value); };
})();
</script>
</body>
</html>
