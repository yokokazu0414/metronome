<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metronome — iOS Audio Unlock Minimal Fix</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#0e1116;color:#e6edf3}
  .wrap{max-width:760px;margin:40px auto;padding:24px}
  .unlock{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:9999}
  .unlock button{font-size:18px;padding:14px 18px;border-radius:14px;background:#238636;border:1px solid #2ea043;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .hidden{display:none}
  .card{background:#161b22;border:1px solid #30363d;border-radius:16px;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0}
  button{border-radius:10px;border:1px solid #30363d;background:#0d1117;color:#e6edf3;padding:10px 12px;font-size:16px;cursor:pointer}
  button.primary{background:#1f6feb;border-color:#1f6feb}
  .warn{background:#3b1d1d;border:1px solid #7f1d1d;padding:8px 12px;border-radius:10px;margin-top:10px}
  .ok{background:#10291a;border:1px solid #1f883d}
  .noselect{ -webkit-user-select:none; user-select:none; }
</style>
</head>
<body>
<div id="unlock" class="unlock"><button id="unlockBtn" type="button">Audioを有効化（タップ）</button></div>
<div class="wrap noselect">
  <h1>iOS オーディオ解放 — 最小テスト版</h1>
  <div class="card">
    <div id="status" class="ok" style="padding:8px 12px;border-radius:10px">状態: 未解放</div>
    <div class="row">
      <button id="selftest" type="button" class="primary">Self Test（短いビープ）</button>
      <button id="holdtest" type="button">（長押し）連続トーン</button>
      <button id="htmlAudio" type="button">HTMLAudioテスト</button>
    </div>
  </div>
</div>

<script>
(function(){
  const AC = window.AudioContext || window.webkitAudioContext;
  let ctx = null, master = null;
  const $ = id => document.getElementById(id);
  const status = $('status');

  function log(s){ status.textContent = '状態: ' + s; }

  function ensureAudio(){
    if (!ctx) {
      try {
        ctx = new AC({ latencyHint: 'interactive' });
      } catch(e){ alert('AudioContext作成に失敗: '+e.message); return; }
      master = ctx.createGain();
      master.gain.value = 0.6;
      master.connect(ctx.destination);
      const b = ctx.createBuffer(1, 1, ctx.sampleRate);
      const s = ctx.createBufferSource(); s.buffer = b; s.connect(master); s.start(0);
    }
    if (ctx.state === 'suspended') ctx.resume();
  }

  function showUnlock(v){ $('unlock').classList.toggle('hidden', !!v); }
  const unlockOnce = async () => {
    ensureAudio();
    try { if (ctx.state === 'suspended') await ctx.resume(); } catch(e){}
    try {
      const b = ctx.createBuffer(1, 1, ctx.sampleRate);
      const s = ctx.createBufferSource(); s.buffer = b; s.connect(master); s.start(0);
    } catch(e){}
    const ok = (ctx.state === 'running');
    log(ok ? '解放済み（running）' : '解放できず（'+ctx.state+'）');
    if (ok) { showUnlock(true); removeUnlockListeners(); }
  };
  const unlockEvents = ['pointerdown','touchstart','pointerup','click'];
  function removeUnlockListeners(){ unlockEvents.forEach(e=>window.removeEventListener(e, unlockOnce, true)); }
  unlockEvents.forEach(e=>window.addEventListener(e, unlockOnce, { capture:true, passive:false }));
  $('unlockBtn').addEventListener('click', unlockOnce, { once:true });

  function beep(accent, when){
    if (!ctx || ctx.state !== 'running') { log('AudioContextが動作していません'); return; }
    const src = ctx.createBufferSource();
    const len = Math.max(1, Math.floor(ctx.sampleRate * 0.1)); // 長めに
    const buf = ctx.createBuffer(1, len, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0;i<len;i++){ const t=i/ctx.sampleRate; const env=Math.exp(-20*t); data[i] = Math.sin(2*Math.PI*(accent?880:440)*t)*env; }
    src.buffer = buf; const g = ctx.createGain(); g.gain.value = accent?0.9:0.6; src.connect(g); g.connect(master); src.start(when||0);
  }

  $('selftest').addEventListener('click', function(){ ensureAudio(); if (!ctx) return; const t = ctx.currentTime; log('Self Test 実行'); beep(true, t+0.01); beep(false, t+0.2); });
  document.getElementById('selftest').addEventListener('touchend', function(e){ e.preventDefault(); ensureAudio(); if (!ctx) return; const t = ctx.currentTime; log('Self Test 実行(touch)'); beep(true, t+0.01); beep(false, t+0.2); }, {passive:false});
    const t = ctx.currentTime;
    beep(true, t+0.01);
    beep(false, t+0.3);
  });

  let holdOsc=null, holdGain=null;
  function startHold(){
    ensureAudio();
    holdOsc = ctx.createOscillator();
    holdGain = ctx.createGain();
    holdOsc.frequency.value = 440;
    holdGain.gain.value = 0.25;
    holdOsc.connect(holdGain);
    holdGain.connect(master);
    holdOsc.start();
  }
  function stopHold(){ if (holdOsc){ holdOsc.stop(); holdOsc.disconnect(); holdGain.disconnect(); holdOsc=null; holdGain=null; } }
  const holdBtn = $('holdtest');
  holdBtn.addEventListener('touchstart', function(e){ e.preventDefault(); startHold(); }, {passive:false});
  holdBtn.addEventListener('mousedown', function(e){ e.preventDefault(); startHold(); });
  holdBtn.addEventListener('click', function(e){ /* click では開始しない */ });
  ['touchend','touchcancel','mouseup','mouseleave'].forEach(function(ev){ holdBtn.addEventListener(ev, function(e){ e.preventDefault(); stopHold(); }, {passive:false}); });

  $('htmlAudio').addEventListener('click', function(){
    log('HTMLAudioテスト 実行');
    const audio = new Audio('data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YQAAAAAAAAD//w8AAP8PAAD/DwAA/w8AAP8PAAD/DwAA');
    audio.play().then(function(){ log('HTMLAudio 再生開始'); }).catch(function(e){ alert('HTMLAudio 再生失敗: '+e.message); });
  });
    audio.play().catch(e=>alert('HTMLAudio 再生失敗: '+e.message));
  });
})();
</script>
</body>
</html>
