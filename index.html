<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Metronome Studio v4 — Mobile Optimized (Full Kit)</title>
<style>
  :root { color-scheme: dark; --bg:#0b0f14; --panel:#10161f; --border:#223040; --text:#e8f0ff; --muted:#8aa0b5; --accent:#3b82f6; --accent2:#10b981; --danger:#ef4444; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; text-align: center; background: var(--bg); color: var(--text); margin:0; }
  h1 { margin: 16px 0 6px; font-size: 22px; }
  .app{ max-width:480px; margin:0 auto; padding:14px; }
  .panel { background: var(--panel); border:1px solid var(--border); border-radius:18px; padding:14px; margin:14px auto; width:min(480px, 94vw); box-shadow:0 12px 28px rgba(0,0,0,.25) }
  .row { display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:10px }
  button, select, input { font-size: 18px; border-radius: 14px; border: 1px solid var(--border); background:#0d131b; color:var(--text) }
  input[type="number"]{ text-align:center; font-weight:800; background:#0b1118 }
  input[type="range"]{ flex:1; min-width:0 }
  .btn.primary{ background:var(--accent2); border-color:#0e8f6d; color:#00160f; font-weight:900 }
  .btn.danger{ background:var(--danger); border-color:#b91c1c; color:#fff; font-weight:800 }
  .icon-btn { width:48px; height:48px; font-size:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
  /* BPM */
  .bpmBlock{ display:flex; align-items:center; gap:10px; justify-content:center }
  #bpm{ width:80px; height:48px; font-size:20px; }
  /* Kit Grid */
  .kitGrid { display:grid; grid-template-columns: repeat(4,1fr); gap:8px; margin-top:8px; }
  .kitGrid-bottom { display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:8px; }
  /* Control Cards */
  .controlCard{ background:#0c1218; border:1px solid var(--border); border-radius:14px; padding:10px; flex:1 }
  .label{ text-align:left; color:var(--muted); font-size:13px }
  /* Unlock overlay */
  #unlockOverlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.7); backdrop-filter: blur(4px); z-index:9999; padding:18px }
  #unlockOverlay .card{ background:#0d131b; border:1px solid var(--border); color:var(--text); border-radius:22px; padding:18px 16px; max-width: 92vw; line-height: 1.65; box-shadow:0 16px 40px rgba(0,0,0,.35) }
  #unlock{ display:block; width:100%; padding:20px; font-size:22px; border-radius:16px; background:var(--accent2); border:1px solid #0e8f6d; color:#00160f; font-weight:900; letter-spacing:.3px }
  #unlock:active{ transform:scale(.98) }
  /* Diag */
  #diag{ text-align:left; margin: 0 auto; width:min(480px, 94vw); }
  #diag pre{ white-space:pre-wrap; background:#0b1118; border:1px solid var(--border); border-radius:12px; padding:10px }
  /* Segmented (未使用ブロック用のスタイル/残しておく) */
  .seg{ display:flex; background:#0c1218; border:1px solid var(--border); border-radius:14px; overflow:hidden }
  .seg button{ flex:1; padding:10px 10px; font-size:16px; border:0; background:transparent; color:var(--text) }
  .seg button.active{ background:var(--accent); color:#fff }
</style>
</head>
<body>
  <div class="app">
    <h1>Metronome Studio v4</h1>
    <div class="panel">
      <!-- BPM -->
      <div class="bpmBlock">
        <button id="bpmMinus" class="icon-btn" aria-label="BPM down">−</button>
        <input id="bpm" type="number" value="100" min="20" max="300" inputmode="numeric" />
        <button id="bpmPlus" class="icon-btn" aria-label="BPM up">＋</button>
      </div>

      <!-- Time signature & subdivision -->
      <div class="row" style="margin-top:8px">
        <div class="controlCard">
          <div class="label">拍子（分子/分母）</div>
          <div style="display:flex; gap:6px; align-items:center">
            <input id="beats" type="number" value="4" min="1" max="12" style="flex:1">
            <span>/</span>
            <input id="beatUnit" type="number" value="4" min="1" max="32" style="flex:1">
          </div>
          <!-- もし分母をセグメントUIにしたい場合は下記を有効化
          <div class="seg" role="group" aria-label="拍子の分母">
            <button class="segBtn active" data-val="4">4</button>
            <button class="segBtn" data-val="8">8</button>
            <button class="segBtn" data-val="16">16</button>
          </div>
          -->
        </div>
        <div class="controlCard">
          <div class="label">細分</div>
          <select id="subdiv">
            <option value="quarter">4分</option>
            <option value="eighth" selected>8分</option>
            <option value="triplet">3連</option>
            <option value="sixteenth">16分</option>
          </select>
        </div>
      </div>

      <!-- Volume -->
      <div class="row" style="margin-top:8px">
        <label style="flex:1">音量: <input id="volume" type="range" min="0" max="1" step="0.01" value="0.7"></label>
      </div>

      <!-- Kit -->
      <div class="kitGrid">
        <label><input type="checkbox" id="kick" checked> Kick</label>
        <label><input type="checkbox" id="snare" checked> Snare</label>
        <label><input type="checkbox" id="hihat" checked> Hi-Hat</label>
        <label><input type="checkbox" id="tamb"> Tambourine</label>
      </div>
      <div class="kitGrid-bottom">
        <label><input type="checkbox" id="shaker"> Shaker</label>
        <label><input type="checkbox" id="conga"> Conga</label>
        <label><input type="checkbox" id="bongo"> Bongo</label>
      </div>

      <!-- Transport -->
      <div class="row" style="margin-top:10px; justify-content:center">
        <button id="start" class="btn primary">Start</button>
        <button id="stop" class="btn danger">Stop</button>
      </div>
    </div>

    <details id="diag" class="panel"><summary>Diagnostics / Self-tests</summary><pre id="diaglog">Running…</pre></details>
  </div>

  <!-- Unlock overlay -->
  <div id="unlockOverlay">
    <div class="card">
      <div style="font-weight:700;margin-bottom:10px">音声を有効化してください</div>
      <div style="opacity:.85;margin-bottom:12px">最初に画面をタップ（または下のボタン）してブラウザのオーディオを許可します。</div>
      <button id="unlock">🎵 Audioを有効化（タップ）</button>
    </div>
  </div>

<script>
(() => {
  // ===== Helpers =====
  const onReady = (fn) => { if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn, { once: true }); };
  const appendLog = (...args) => {
    const pre = document.getElementById('diaglog');
    if (!pre) return;
    const line = args.map(a => (typeof a === 'string' ? a : (()=>{ try { return JSON.stringify(a); } catch { return String(a); } })())).join(' ');
    pre.appendChild(document.createTextNode('\n' + line)); // 安全に改行
  };
  const log = (...args) => { try { console.log('[Metronome]', ...args); } catch(_){} appendLog(...args); };
  const el = (id) => { const n = document.getElementById(id); if (!n) throw new Error('Missing #' + id); return n; };

  // ===== Audio & State =====
  let ctx, master;
  let bpm=100, beats=4, beatUnit=4, subdiv='eighth';
  let playing=false, step=0, nextTime=0;
  const schedAhead=0.14;

  function initAudio(){
    if (ctx) return ctx;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = parseFloat(el('volume').value||'0.7');
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.setValueAtTime(-12, ctx.currentTime);
    comp.knee.setValueAtTime(30, ctx.currentTime);
    comp.ratio.setValueAtTime(4, ctx.currentTime);
    comp.attack.setValueAtTime(0.003, ctx.currentTime);
    comp.release.setValueAtTime(0.25, ctx.currentTime);
    master.connect(comp).connect(ctx.destination);
    return ctx;
  }

  async function unlockAudio(){
    initAudio();
    try { if (ctx.state === 'suspended') await ctx.resume(); } catch(e){}
    try { const s = ctx.createBufferSource(); const b = ctx.createBuffer(1,1,ctx.sampleRate); s.buffer=b; s.connect(master); s.start(0); } catch(e) {}
    const ov = document.getElementById('unlockOverlay'); if (ctx.state==='running' && ov) ov.style.display='none';
    log('unlock:', ctx && ctx.state);
  }

  function computeSecPerStep(_bpm,_beatUnit,_subdiv){
    const spb = 60 / _bpm; // seconds per beat where beat = note of denominator
    const stepsPerBeat = _subdiv==='quarter'?1:_subdiv==='eighth'?2:_subdiv==='triplet'?3:4;
    return spb * (4/_beatUnit) / stepsPerBeat;
  }

  // ===== Instruments =====
  function playKick(t){ const osc = ctx.createOscillator(); const g = ctx.createGain(); osc.frequency.setValueAtTime(150,t); osc.frequency.exponentialRampToValueAtTime(50,t+0.1); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3); osc.connect(g).connect(master); osc.start(t); osc.stop(t+0.3); }
  function playSnare(t){ const n=ctx.createBufferSource(); const b=ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=Math.random()*2-1; } n.buffer=b; const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=1500; const g=ctx.createGain(); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.2); n.connect(f).connect(g).connect(master); n.start(t); n.stop(t+0.2); }
  function playHihat(t){ const n=ctx.createBufferSource(); const b=ctx.createBuffer(1, ctx.sampleRate*0.04, ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=Math.random()*2-1; } n.buffer=b; const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=7000; const g=ctx.createGain(); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.05); n.connect(f).connect(g).connect(master); n.start(t); n.stop(t+0.05); }

  // ★ Tambourine: 複数グレインの明るいジングル（Hi-Hat と明確に差別化）
  function playTamb(t){
    const grains = 4;
    for (let k = 0; k < grains; k++) {
      const delay = (k === 0 ? 0 : (0.010 + Math.random()*0.020) * k); // 小刻みスプレッド
      const n = ctx.createBufferSource();
      const len = (ctx.sampleRate * 0.022) | 0; // ごく短い粒
      const b = ctx.createBuffer(1, len, ctx.sampleRate);
      const d = b.getChannelData(0);
      for (let i = 0; i < d.length; i++) {
        d[i] = (Math.random()*2 - 1) * Math.exp(-i / (len * 0.6)); // 先鋭ノイズ
      }
      n.buffer = b;
      const bp1 = ctx.createBiquadFilter(); bp1.type='bandpass'; bp1.frequency.value = 7500 + Math.random()*2000; bp1.Q.value = 8;
      const bp2 = ctx.createBiquadFilter(); bp2.type='bandpass'; bp2.frequency.value = 12000; bp2.Q.value = 3;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.55, t + delay);
      g.gain.exponentialRampToValueAtTime(0.001, t + delay + 0.08);
      n.connect(bp1).connect(bp2).connect(g).connect(master);
      n.start(t + delay); n.stop(t + delay + 0.09);
    }
  }

  function playShaker(t){ const n=ctx.createBufferSource(); const len=(ctx.sampleRate*0.05)|0; const b=ctx.createBuffer(1,len,ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=Math.random()*2-1; } n.buffer=b; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=3000; bp.Q.value=1.2; const g=ctx.createGain(); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.06); n.connect(bp).connect(g).connect(master); n.start(t); n.stop(t+0.07); }
  function playConga(t){ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(400,t); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2); o.connect(g).connect(master); o.start(t); o.stop(t+0.2); }
  function playBongo(t){ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(600,t); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.15); o.connect(g).connect(master); o.start(t); o.stop(t+0.15); }

  // ===== Scheduler =====
  function scheduleStep(i,t){
    const stepsPerBeat = subdiv==='quarter'?1:subdiv==='eighth'?2:subdiv==='triplet'?3:4;
    const beatIndex = Math.floor(i/stepsPerBeat);
    const stepInBeat = i % stepsPerBeat; const beatInBar = beatIndex % beats;
    if(el('kick').checked && stepInBeat===0) playKick(t);
    if(el('snare').checked && stepInBeat===0 && (beatInBar%2===1)) playSnare(t);
    if(el('hihat').checked) playHihat(t);
    if(el('tamb').checked) playTamb(t);
    if(el('shaker').checked) playShaker(t);
    if(el('conga').checked && stepInBeat===0 && beatInBar%2===0) playConga(t);
    if(el('bongo').checked){ const perBeat=2; const eighth=(stepInBeat*perBeat)/stepsPerBeat; if(Number.isInteger(eighth) && (eighth%2===1)) playBongo(t); }
  }

  function scheduler(){ while(nextTime < ctx.currentTime + schedAhead){ scheduleStep(step, nextTime); nextTime += computeSecPerStep(bpm, beatUnit, subdiv); step++; } }

  async function play(){
    await unlockAudio();
    bpm = parseInt(el('bpm').value||'100',10);
    beats = parseInt(el('beats').value||'4',10);
    beatUnit = parseInt(el('beatUnit').value||'4',10);
    subdiv = (el('subdiv').value||'eighth');
    playing=true; step=0; nextTime=ctx.currentTime+0.05;
    (function tick(){ if(!playing) return; scheduler(); requestAnimationFrame(tick); })();
  }
  function stop(){ playing=false; }

  onReady(()=>{
    // Wire controls
    el('unlock').addEventListener('click', unlockAudio);
    el('start').addEventListener('click', play);
    el('stop').addEventListener('click', stop);
    el('volume').addEventListener('input', (e)=>{ if(master) master.gain.value=parseFloat(e.target.value||'0.7'); });
    el('bpmMinus').addEventListener('click', ()=>{ const v=Math.max(20, parseInt(el('bpm').value||'100',10)-1); el('bpm').value=v; });
    el('bpmPlus').addEventListener('click', ()=>{ const v=Math.min(300, parseInt(el('bpm').value||'100',10)+1); el('bpm').value=v; });

    // （分母をセグメントUIにする場合の配線。現状は未表示だが一応残す）
    document.querySelectorAll('.segBtn').forEach(btn=> btn.addEventListener('click', ()=>{
      document.querySelectorAll('.segBtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const v = parseInt(btn.dataset.val, 10); if(!Number.isNaN(v)) el('beatUnit').value = String(v);
    }));

    // iOS系フォールバック
    document.addEventListener('pointerdown', ()=>{ if(!ctx || ctx.state!=='running'){ unlockAudio(); } }, { once:true });
    document.addEventListener('visibilitychange', ()=>{ if(ctx && document.visibilityState==='visible' && ctx.state==='suspended'){ ctx.resume(); } });

    // ===== Self-tests =====
    const results = [];
    const pass = (name)=> results.push('PASS  ' + name);
    const fail = (name, extra='')=> results.push('FAIL  ' + name + (extra? ' — ' + extra : ''));

    try {
      const required = ['bpm','beats','beatUnit','subdiv','start','stop','unlock','volume','kick','snare','hihat'];
      const ok = required.every(id => !!document.getElementById(id));
      ok ? pass('DOM elements present: ' + required.join(', ')) : fail('DOM elements missing', required.filter(id=>!document.getElementById(id)).join(', '));
    } catch(e){ fail('DOM presence check', e.message); }

    try {
      const s1 = computeSecPerStep(120,4,'eighth');
      const s2 = computeSecPerStep(60,4,'quarter');
      const s3 = computeSecPerStep(90,8,'sixteenth');
      Math.abs(s1-0.25)<1e-6 ? pass('secPerStep(120,4,eighth)=0.25s') : fail('secPerStep case1', 'got '+s1);
      Math.abs(s2-1.0)<1e-6 ? pass('secPerStep(60,4,quarter)=1.0s') : fail('secPerStep case2', 'got '+s2);
      Math.abs(s3-(60/90*(4/8)/4))<1e-6 ? pass('secPerStep(90,8,sixteenth) math ok') : fail('secPerStep case3', 'got '+s3);
    } catch(e){ fail('Timing math', e.message); }

    try { initAudio(); pass('AudioContext created (no resume)'); } catch(e){ fail('AudioContext init', e.message); }

    // log テスト（安全な改行／循環参照フォールバック）
    try { log('TEST', { a:1 }); pass('log basic works'); } catch(e){ fail('log basic failed', e.message); }
    try { const circular={}; circular.self=circular; log('circular', circular); pass('log circular fallback works'); } catch(e){ fail('log circular', e.message); }

    const pre = document.getElementById('diaglog'); if (pre) pre.textContent = (pre.textContent||'') + '\n' + results.join('\n');
  });
})();
</script>
</body>
</html>
