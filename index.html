<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>エミリアピアノ教室 メトロノーム</title>
<style>
  :root{
    /* エミリアピアノ教室のブランドカラーに基づく配色 */
    --primary: #7B4397;
    --primary-light: #A569BD;
    --secondary: #DC7633;
    --accent: #E8B4D4;
    --warm-cream: #FDF6E3;
    --soft-pink: #FCE4EC;
    
    /* 背景グラデーション - 温かみのあるピンクベース */
    --bg-gradient: linear-gradient(135deg, #FDF6E3 0%, #FCE4EC 30%, #F8E8F5 60%, #F3E5F5 100%);
    
    /* パネルとUI要素 */
    --panel-bg: rgba(255, 255, 255, 0.92);
    --panel-border: rgba(123, 67, 151, 0.15);
    --card-bg: rgba(253, 246, 227, 0.8);
    --card-border: rgba(220, 118, 51, 0.2);
    
    /* テキストカラー */
    --text-dark: #2C1810;
    --text-medium: #5D4037;
    --text-light: #8D6E63;
    --text-accent: #7B4397;
    
    /* シャドウ */
    --shadow-primary: 0 8px 32px rgba(123, 67, 151, 0.15);
    --shadow-warm: 0 4px 20px rgba(220, 118, 51, 0.12);
    --shadow-soft: 0 2px 12px rgba(123, 67, 151, 0.1);
  }
  
  *,*::before,*::after{ box-sizing:border-box }
  
  html,body{
    margin:0; padding:0; width:100%; max-width:100%; overflow-x:hidden;
    background: var(--bg-gradient);
    color: var(--text-dark);
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic Medium", "Meiryo", sans-serif;
    min-height: 100vh;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  /* 優雅な装飾パターン */
  .decorative-pattern {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 150px;
    background: 
      radial-gradient(circle at 20% 20%, rgba(123, 67, 151, 0.03) 0%, transparent 50%),
      radial-gradient(circle at 80% 40%, rgba(220, 118, 51, 0.02) 0%, transparent 50%),
      radial-gradient(circle at 40% 80%, rgba(232, 180, 212, 0.04) 0%, transparent 50%);
    z-index: -1;
  }

  .app{ 
    max-width: 380px; 
    margin: 0 auto; 
    padding: max(20px, env(safe-area-inset-top) + 15px) 20px calc(env(safe-area-inset-bottom) + 20px);
    position: relative;
    z-index: 1;
  }

  .header {
    text-align: center;
    margin-bottom: 32px;
    padding: 25px 0 15px;
  }

  .title {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(45deg, var(--primary), var(--primary-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0 0 8px 0;
    letter-spacing: 0.8px;
    text-shadow: 0 2px 4px rgba(123, 67, 151, 0.1);
  }

  .subtitle {
    font-size: 18px;
    color: var(--text-medium);
    margin: 0 0 6px 0;
    font-weight: 600;
    letter-spacing: 0.3px;
  }

  .author {
    font-size: 12px;
    color: var(--text-light);
    opacity: 0.8;
    font-weight: 400;
    font-style: italic;
  }

  .panel{
    background: var(--panel-bg);
    backdrop-filter: blur(12px);
    border: 1.5px solid var(--panel-border);
    border-radius: 28px;
    padding: 28px 24px;
    margin: 0 auto 24px;
    box-shadow: var(--shadow-primary);
    position: relative;
    overflow: hidden;
  }

  .panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
  }

  .section { 
    margin: 24px 0;
  }

  .section:first-child {
    margin-top: 0;
  }

  .label {
    font-size: 15px;
    color: var(--text-accent);
    margin-bottom: 14px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    letter-spacing: 0.2px;
  }

  .label::before {
    content: '♪';
    color: var(--secondary);
    font-size: 18px;
    filter: drop-shadow(0 1px 2px rgba(220, 118, 51, 0.3));
  }

  .bpm-section {
    text-align: center;
    padding: 24px 0;
    background: var(--card-bg);
    border-radius: 20px;
    border: 1px solid var(--card-border);
    margin: 20px 0;
  }

  .bpm-display {
    font-size: 52px;
    font-weight: 800;
    color: var(--primary);
    margin: 18px 0;
    text-shadow: 0 2px 8px rgba(123, 67, 151, 0.2);
    letter-spacing: -1px;
  }

  .bpm-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 24px;
    margin-top: 24px;
  }

  .bpm-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    font-size: 32px;
    font-weight: bold;
    box-shadow: var(--shadow-warm);
    transition: all 0.25s ease;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bpm-btn:active {
    transform: scale(0.94);
    box-shadow: var(--shadow-soft);
  }

  .bpm-btn:hover {
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
  }

  .bpm-input {
    width: 130px;
    height: 54px;
    font-size: 26px;
    font-weight: 700;
    text-align: center;
    border: 2px solid var(--panel-border);
    border-radius: 18px;
    background: rgba(255, 255, 255, 0.9);
    color: var(--text-dark);
    backdrop-filter: blur(8px);
    box-shadow: inset 0 2px 4px rgba(123, 67, 151, 0.08);
  }

  .controls-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 18px;
    margin: 24px 0;
  }

  .control-card {
    background: var(--card-bg);
    border: 1.5px solid var(--card-border);
    border-radius: 18px;
    padding: 18px;
    backdrop-filter: blur(8px);
    box-shadow: var(--shadow-soft);
  }

  .control-pair {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }

  .control-input {
    flex: 1;
    height: 46px;
    font-size: 17px;
    font-weight: 600;
    text-align: center;
    border: 1.5px solid var(--card-border);
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.9);
    color: var(--text-dark);
    box-shadow: inset 0 1px 3px rgba(123, 67, 151, 0.06);
  }

  .control-select {
    width: 100%;
    height: 46px;
    font-size: 16px;
    font-weight: 600;
    text-align: center;
    border: 1.5px solid var(--card-border);
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.9);
    color: var(--text-dark);
    margin-top: 10px;
    box-shadow: inset 0 1px 3px rgba(123, 67, 151, 0.06);
  }

  .volume-section {
    padding: 20px;
    background: var(--card-bg);
    border-radius: 18px;
    border: 1.5px solid var(--card-border);
    box-shadow: var(--shadow-soft);
  }

  .volume-slider {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--warm-cream), var(--secondary), var(--primary));
    appearance: none;
    outline: none;
    margin: 16px 0;
    box-shadow: inset 0 1px 3px rgba(123, 67, 151, 0.1);
  }

  .volume-slider::-webkit-slider-thumb {
    appearance: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    box-shadow: var(--shadow-warm);
    cursor: pointer;
    border: 2px solid white;
  }

  .volume-slider::-moz-range-thumb {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    box-shadow: var(--shadow-warm);
    cursor: pointer;
    border: 2px solid white;
  }

  .kit-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 14px;
    margin: 18px 0;
  }

  .kit-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 18px;
    background: var(--card-bg);
    border: 1.5px solid var(--card-border);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.25s ease;
    backdrop-filter: blur(8px);
    box-shadow: var(--shadow-soft);
  }

  .kit-item:hover {
    background: rgba(253, 246, 227, 0.95);
    border-color: var(--secondary);
    transform: translateY(-1px);
  }

  .kit-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary);
    border-radius: 4px;
  }

  .kit-item label {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-dark);
    cursor: pointer;
    flex: 1;
    letter-spacing: 0.1px;
  }

  .play-controls {
    display: flex;
    gap: 18px;
    justify-content: center;
    margin-top: 36px;
    padding: 12px 0;
  }

  .play-btn {
    flex: 1;
    max-width: 145px;
    height: 60px;
    border: none;
    border-radius: 30px;
    font-size: 19px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: var(--shadow-warm);
    letter-spacing: 0.5px;
  }

  .play-btn.start {
    background: linear-gradient(135deg, #27AE60, #2ECC71);
    color: white;
  }

  .play-btn.stop {
    background: linear-gradient(135deg, #E74C3C, #C0392B);
    color: white;
  }

  .play-btn:active {
    transform: scale(0.97);
  }

  .play-btn:hover {
    box-shadow: var(--shadow-primary);
    transform: translateY(-1px);
  }

  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(123, 67, 151, 0.2), transparent);
    margin: 28px 0;
  }

  /* Unlock overlay */
  #unlockOverlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(253, 246, 227, 0.96);
    backdrop-filter: blur(12px);
    z-index: 9999;
    padding: 20px;
    transition: opacity 0.4s ease;
  }

  #unlockOverlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .unlock-card {
    background: var(--panel-bg);
    backdrop-filter: blur(12px);
    border: 1.5px solid var(--panel-border);
    border-radius: 28px;
    padding: 36px 28px;
    text-align: center;
    max-width: 340px;
    box-shadow: var(--shadow-primary);
  }

  .unlock-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-accent);
    margin-bottom: 14px;
  }

  .unlock-message {
    font-size: 17px;
    color: var(--text-medium);
    margin-bottom: 28px;
    line-height: 1.6;
  }

  #unlock {
    width: 100%;
    height: 60px;
    border: none;
    border-radius: 30px;
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    color: white;
    font-size: 19px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: var(--shadow-warm);
    transition: all 0.25s ease;
    letter-spacing: 0.5px;
  }

  #unlock:active {
    transform: scale(0.97);
  }

  #unlock:hover {
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
  }

  /* Responsive adjustments */
  @media (max-width: 375px) {
    .app { padding-left: 16px; padding-right: 16px; }
    .bpm-display { font-size: 46px; }
    .controls-row { gap: 14px; }
    .kit-grid { grid-template-columns: 1fr; }
    .bpm-controls { gap: 20px; }
    .bpm-btn { width: 58px; height: 58px; font-size: 28px; }
  }

  /* 美しいフォーカス状態 */
  input:focus, select:focus, button:focus {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }
</style>
</head>
<body>
  <div class="decorative-pattern"></div>
  
  <!-- Unlock overlay -->
  <div id="unlockOverlay">
    <div class="unlock-card">
      <div class="unlock-title">🎵 音声を有効化</div>
      <div class="unlock-message">メトロノームを開始するために<br>画面をタップしてください</div>
      <button id="unlock">タップして開始</button>
    </div>
  </div>

  <div class="app">
    <div class="header">
      <h1 class="title">エミリアピアノ教室</h1>
      <div class="subtitle">メトロノーム</div>
      <div class="author">Created by 新田ナオミ</div>
    </div>

    <div class="panel">
      <!-- BPM Section -->
      <div class="section bmp-section">
        <div class="label">テンポ設定</div>
        <div class="bpm-section">
          <div class="bpm-display" id="bpmDisplay">100</div>
          <div class="bpm-controls">
            <button id="bpmMinus" class="bmp-btn">−</button>
            <input id="bpm" class="bpm-input" type="number" value="100" min="20" max="300" />
            <button id="bpmPlus" class="bpm-btn">＋</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Time signature & subdivision -->
      <div class="section">
        <div class="label">拍子とリズム</div>
        <div class="controls-row">
          <div class="control-card">
            <div class="label" style="margin-bottom: 8px; font-size: 13px;">拍子記号</div>
            <div class="control-pair">
              <input id="beats" class="control-input" type="number" value="4" min="1" max="12">
              <span style="color: var(--text-light); font-size: 22px; font-weight: bold;">/</span>
              <input id="beatUnit" class="control-input" type="number" value="4" min="1" max="32">
            </div>
          </div>
          <div class="control-card">
            <div class="label" style="margin-bottom: 8px; font-size: 13px;">音符の種類</div>
            <select id="subdiv" class="control-select">
              <option value="quarter">4分音符</option>
              <option value="eighth" selected>8分音符</option>
              <option value="triplet">3連符</option>
              <option value="sixteenth">16分音符</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Volume -->
      <div class="section">
        <div class="label">音量調整</div>
        <div class="volume-section">
          <input id="volume" class="volume-slider" type="range" min="0" max="1" step="0.01" value="0.7">
        </div>
      </div>

      <div class="divider"></div>

      <!-- Kit -->
      <div class="section">
        <div class="label">楽器の選択</div>
        <div class="kit-grid">
          <div class="kit-item">
            <input type="checkbox" id="kick" checked>
            <label for="kick">キック</label>
          </div>
          <div class="kit-item">
            <input type="checkbox" id="snare" checked>
            <label for="snare">スネア</label>
          </div>
          <div class="kit-item">
            <input type="checkbox" id="hihat" checked>
            <label for="hihat">ハイハット</label>
          </div>
          <div class="kit-item">
            <input type="checkbox" id="tamb">
            <label for="tamb">タンバリン</label>
          </div>
          <div class="kit-item">
            <input type="checkbox" id="shaker">
            <label for="shaker">シェイカー</label>
          </div>
          <div class="kit-item">
            <input type="checkbox" id="conga">
            <label for="conga">コンガ</label>
          </div>
        </div>
      </div>

      <div class="play-controls">
        <button id="start" class="play-btn start">▶ 開始</button>
        <button id="stop" class="play-btn stop">⏸ 停止</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  let ctx, master;
  function initAudio(){
    if (ctx) return ctx;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = parseFloat(el('volume').value||'0.7');
    master.connect(ctx.destination);
    return ctx;
  }

  function unlockAudioNow(){
    initAudio();
    try{ ctx.resume(); }catch(e){}
    try{ 
      const s=ctx.createBufferSource(); 
      s.buffer=ctx.createBuffer(1,1,ctx.sampleRate); 
      s.connect(master); 
      s.start(0);
    }catch(e){}
    const ov = el('unlockOverlay'); 
    if (ctx && ctx.state==='running' && ov) {
      ov.classList.add('hidden');
    }
  }

  function playKick(t, vol=1){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(160,t);
    o.frequency.exponentialRampToValueAtTime(55,t+0.10);
    g.gain.setValueAtTime(1.0*vol,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.28);
    o.connect(g).connect(master); o.start(t); o.stop(t+0.32);
  }

  function playSnare(t, vol=1){
    const tone=ctx.createOscillator(), tg=ctx.createGain();
    tone.type='triangle';
    tone.frequency.setValueAtTime(190,t);
    tg.gain.setValueAtTime(0.25*vol,t);
    tg.gain.exponentialRampToValueAtTime(0.001,t+0.14);
    const n=ctx.createBufferSource(), b=ctx.createBuffer(1, ctx.sampleRate*0.20, ctx.sampleRate);
    const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
    n.buffer=b; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800;
    const ng=ctx.createGain(); ng.gain.setValueAtTime(0.8*vol,t); ng.gain.exponentialRampToValueAtTime(0.001,t+0.20);
    tone.connect(tg).connect(master);
    n.connect(hp).connect(ng).connect(master);
    tone.start(t); tone.stop(t+0.18);
    n.start(t); n.stop(t+0.2);
  }

  function playHihat(t, vol=1){
    const n=ctx.createBufferSource(); const b=ctx.createBuffer(1, ctx.sampleRate*0.04, ctx.sampleRate);
    const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
    n.buffer=b; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000;
    const g=ctx.createGain(); g.gain.setValueAtTime(0.6*vol,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.05);
    n.connect(hp).connect(g).connect(master); n.start(t); n.stop(t+0.05);
  }

  function playTamb(t, vol=1){
    // Tambourine sound synthesis
    const n=ctx.createBufferSource(); 
    const b=ctx.createBuffer(1, ctx.sampleRate*0.15, ctx.sampleRate);
    const d=b.getChannelData(0); 
    for(let i=0;i<d.length;i++) {
      d[i]=(Math.random()*2-1) * Math.sin(i*0.02) * 0.3;
    }
    n.buffer=b; 
    const hp=ctx.createBiquadFilter(); 
    hp.type='highpass'; 
    hp.frequency.value=3000;
    const g=ctx.createGain(); 
    g.gain.setValueAtTime(0.4*vol,t); 
    g.gain.exponentialRampToValueAtTime(0.01,t+0.15);
    n.connect(hp).connect(g).connect(master); 
    n.start(t); 
    n.stop(t+0.15);
  }

  let bpmVal=100, beats=4, beatUnit=4, subdiv='eighth';
  let playing=false, step=0, nextTime=0;
  const ahead=0.14;

  function secPerStep(){
    const spb = 60 / bpmVal;
    const stepsPerBeat = subdiv==='quarter'?1:subdiv==='eighth'?2:subdiv==='triplet'?3:4;
    return spb * (4/beatUnit) / stepsPerBeat;
  }

  function scheduleStep(i, t){
    const stepsPerBeat = subdiv==='quarter'?1:subdiv==='eighth'?2:subdiv==='triplet'?3:4;
    const beatIndex = Math.floor(i/stepsPerBeat);
    const stepInBeat = i % stepsPerBeat;
    const beatInBar  = beatIndex % beats;

    // ハイハット
    if (el('hihat').checked){
      const hhLevel = (stepInBeat===0) ? 0.75 : 0.50;
      playHihat(t, hhLevel);
    }

    if (stepInBeat===0){
      if (el('snare').checked && (beatInBar===1 || beatInBar===3)){
        playSnare(t, beatInBar===1 ? 0.95 : 0.90);
      }
      if (el('kick').checked && (beatInBar===0 || beatInBar===2)){
        playKick(t, beatInBar===0 ? 1.00 : 0.90);
      }
      if (el('tamb').checked && beatInBar === 0) {
        playTamb(t, 0.6);
      }
    }
  }

  function scheduler(){
    while(nextTime < ctx.currentTime + ahead){
      scheduleStep(step, nextTime);
      nextTime += secPerStep();
      step++;
    }
    if (playing) requestAnimationFrame(scheduler);
  }

  function updateBpmDisplay() {
    el('bpmDisplay').textContent = el('bpm').value;
  }

  function start(){
    if (!ctx || ctx.state!=='running') unlockAudioNow();
    bpmVal = parseInt(el('bpm').value||'100',10);
    beats  = parseInt(el('beats').value||'4',10);
    beatUnit = parseInt(el('beatUnit').value||'4',10);
    subdiv = (el('subdiv').value||'eighth');
    playing=true; step=0; nextTime=ctx.currentTime+0.05;
    scheduler();
  }

  function stop(){ 
    playing=false; 
  }

  // Event listeners
  const unlockBtn = el('unlock');
  if (unlockBtn){
    unlockBtn.addEventListener('click', unlockAudioNow);
    unlockBtn.addEventListener('touchend', unlockAudioNow);
  }

  document.addEventListener('pointerdown', ()=>{
    if(!ctx || ctx.state!=='running') unlockAudioNow();
  });

  el('start').addEventListener('click', start);
  el('stop').addEventListener('click', stop);

  el('bpmMinus').addEventListener('click', ()=>{ 
    const newVal = Math.max(20, parseInt(el('bpm').value||'100',10)-1);
    el('bpm').value = newVal;
    updateBpmDisplay();
  });
  
  el('bpmPlus').addEventListener('click', ()=>{ 
    const newVal = Math.min(300, parseInt(el('bpm').value||'100',10)+1);
    el('bpm').value = newVal;
    updateBpmDisplay();
  });

  el('bpm').addEventListener('input', updateBpmDisplay);

  el('volume').addEventListener('input', (e)=>{
    if(master) master.gain.value=parseFloat(e.target.value||'0.7');
  });

  // Initialize display
  updateBpmDisplay();
})();
</script>
</body>
</html>
