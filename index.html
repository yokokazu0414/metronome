<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Metronome Studio v4 — Mobile Optimized (Full Kit)</title>
<style>
  /* ===== Theme & Reset (mobile-first, no horizontal scroll) ===== */
  :root{
    color-scheme: dark;
    --bg:#0d1117;         /* deep charcoal */
    --bg2:#0f141b;        /* card shadow tone */
    --panel:#121821;      /* card */
    --border:#2a3442;     /* hairline */
    --divider:#3b4656;    /* slightly brighter for separators */
    --text:#e7ecf3;       /* main text */
    --muted:#9fb0c3;      /* muted text */
    --accent:#7dd3fc;     /* ice blue */
    --accent2:#c0cad6;    /* SILVER accent */
    --ok:#10b981;         /* primary */
    --danger:#ef4444;     /* danger */
  }
  *,*::before,*::after{ box-sizing:border-box }
  html,body{
    margin:0; padding:0; width:100%; max-width:100%; overflow-x:hidden;
    background:
      radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.06), transparent 60%),
      linear-gradient(180deg, #0f141b 0%, #0c1117 70%, #0b1014 100%);
    color:var(--text);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
  }
  img,svg,video,canvas{ max-width:100%; height:auto }
  button,select,input{ font-size:17px; border-radius:14px; border:1px solid var(--border); background:#0f151c; color:var(--text) }
  input[type="number"]{ text-align:center; font-weight:800; background:#0c1218 }
  input[type="range"]{ width:100%; appearance:none; height:28px; background:transparent; padding:0; margin:0 }
  input[type="range"]::-webkit-slider-runnable-track{ height:4px; background:linear-gradient(90deg, var(--accent2), #93a1b4); border-radius:999px }
  input[type="range"]::-webkit-slider-thumb{ appearance:none; width:22px; height:22px; border-radius:50%; background:#e7edf6; border:1px solid #c9d2de; margin-top:-9px }
  input[type="range"]::-moz-range-track{ height:4px; background:linear-gradient(90deg, var(--accent2), #93a1b4); border-radius:999px }
  input[type="range"]::-moz-range-thumb{ width:22px; height:22px; border-radius:50%; background:#e7edf6; border:1px solid #c9d2de }

  /* ===== Layout ===== */
  h1{ margin: 18px 0 8px; font-size: 22px; letter-spacing:.2px; color:#eef3fb; text-align:center }
  .app{ max-width:520px; margin:0 auto; padding: max(10px, env(safe-area-inset-top)) 14px 24px }
  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.02)) , var(--panel);
    border:1px solid var(--border); border-radius:20px; padding:16px; margin:14px auto 18px;
    width:min(520px, 94vw); box-shadow: 0 10px 30px rgba(0,0,0,.35)
  }
  .row{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:12px }
  .section{ display:grid; gap:10px; margin-top:10px }
  .divider{ height:1px; background:linear-gradient(90deg, transparent, var(--divider), transparent); margin:12px 0 }

  /* ===== BPM (pill controls, centered) ===== */
  .bpmBlock{ display:grid; grid-template-columns: 56px 1fr 56px; gap:10px; align-items:center; justify-items:center }
  .bpmBlock .icon-btn{ width:56px; height:56px; font-size:24px; border-radius:999px; background:linear-gradient(180deg,#121a23,#0e141b); border:1px solid var(--border); box-shadow:0 2px 0 rgba(0,0,0,.28) }
  .bpmBlock .icon-btn:active{ transform:translateY(1px) }
  #bpm{ width:120px; height:56px; font-size:22px; border:1px solid var(--border); border-radius:16px }

  /* ===== Cards ===== */
  .controlCard{ background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)), #0f151c; border:1px solid var(--border); border-radius:16px; padding:12px; flex:1; min-width:0 }
  .label{ text-align:left; color:var(--accent2); font-size:12px; letter-spacing:.3px; text-transform:uppercase }
  .pair{ display:grid; grid-template-columns: 1fr auto 1fr; gap:8px; align-items:center }
  .pair > *{ min-width:0 }  /* prevent overflow on narrow screens */

  /* ===== Segmented (beat unit option) ===== */
  .seg{ display:flex; background:#0d141c; border:1px solid var(--border); border-radius:14px; overflow:hidden }
  .seg button{ flex:1; padding:10px 10px; font-size:15px; border:0; background:transparent; color:var(--text) }
  .seg button.active{ background:rgba(125,211,252,.18); color:#eaf6ff }

  /* ===== Kit grid (top 4 / bottom 3) ===== */
  .kitGrid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px }
  .kitGrid-bottom{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:10px }
  .chip{ display:flex; align-items:center; gap:10px; padding:12px; border:1px solid var(--border); background:#0f151c; border-radius:14px; min-height:48px; min-width:0 }
  .chip input{ transform:scale(1.1) }

  /* ===== Buttons ===== */
  .btn{ padding:14px 18px; border-radius:14px; border:1px solid var(--border); background:#0f151c; color:var(--text) }
  .btn.primary{ background:linear-gradient(180deg,#b9c5d3,#a7b5c6); border-color:#95a6ba; color:#0b1117; font-weight:800 } /* silver-ish */
  .btn.danger{ background:#ab2a2a; border-color:#8f2121; color:#fff; font-weight:800 }

  /* ===== Unlock overlay ===== */
  #unlockOverlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(4,6,10,.65); backdrop-filter: blur(5px); z-index:9999; padding:18px }
  #unlockOverlay .card{ background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), #0e141b; border:1px solid var(--border); color:var(--text); border-radius:22px; padding:18px 16px; max-width: 92vw; line-height: 1.65; box-shadow:0 16px 40px rgba(0,0,0,.35) }
  #unlock{ display:block; width:100%; padding:18px; font-size:20px; border-radius:16px; background:linear-gradient(180deg, #cfd7e2, #b7c3d1); border:1px solid #9aa9bd; color:#0a0f14; font-weight:900; letter-spacing:.2px }
  #unlock:active{ transform:translateY(1px) }

  /* ===== Diagnostics ===== */
  #diag{ text-align:left; margin: 0 auto; width:min(520px, 94vw) }
  #diag pre{ white-space:pre-wrap; background:#0b1118; border:1px solid var(--border); border-radius:12px; padding:10px }

  /* ===== Mobile tweaks ===== */
  @media (max-width: 360px){
    #bpm{ width:100px }
    .bpmBlock{ grid-template-columns: 48px 1fr 48px }
    .bpmBlock .icon-btn{ width:48px; height:48px }
  }
</style>
</head>
<body>
  <div class="app">
    <h1>Metronome Studio v4</h1>

    <div class="panel" aria-label="Metronome Controls">
      <!-- BPM -->
      <div class="section">
        <div class="label">テンポ</div>
        <div class="bpmBlock">
          <button id="bpmMinus" class="icon-btn" aria-label="BPM down">−</button>
          <input id="bpm" type="number" value="100" min="20" max="300" inputmode="numeric" />
          <button id="bpmPlus" class="icon-btn" aria-label="BPM up">＋</button>
        </div>
      </div>

      <div class="divider" aria-hidden="true"></div>

      <!-- Time signature & subdivision -->
      <div class="row">
        <div class="controlCard">
          <div class="label">拍子（分子/分母）</div>
          <div class="pair">
            <input id="beats" type="number" value="4" min="1" max="12">
            <span style="opacity:.6">/</span>
            <input id="beatUnit" type="number" value="4" min="1" max="32">
          </div>
        </div>
        <div class="controlCard">
          <div class="label">細分</div>
          <select id="subdiv">
            <option value="quarter">4分</option>
            <option value="eighth" selected>8分</option>
            <option value="triplet">3連</option>
            <option value="sixteenth">16分</option>
          </select>
        </div>
      </div>

      <div class="section" style="margin-top:14px">
        <div class="label">音量</div>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.7">
      </div>

      <div class="divider" aria-hidden="true"></div>

      <!-- Kit -->
      <div class="section">
        <div class="label">キット</div>
        <div class="kitGrid">
          <label class="chip"><input type="checkbox" id="kick" checked> Kick</label>
          <label class="chip"><input type="checkbox" id="snare" checked> Snare</label>
          <label class="chip"><input type="checkbox" id="hihat" checked> Hi‑Hat</label>
          <label class="chip"><input type="checkbox" id="tamb"> Tambourine</label>
        </div>
        <div class="kitGrid-bottom">
          <label class="chip"><input type="checkbox" id="shaker"> Shaker</label>
          <label class="chip"><input type="checkbox" id="conga"> Conga</label>
          <label class="chip"><input type="checkbox" id="bongo"> Bongo</label>
        </div>
      </div>

      <div class="row" style="margin-top:14px; justify-content:center">
        <button id="start" class="btn primary">Start</button>
        <button id="stop" class="btn danger">Stop</button>
      </div>
    </div>

    <details id="diag" class="panel"><summary>Diagnostics / Self‑tests</summary><pre id="diaglog">Running…</pre></details>
  </div>

  <!-- Unlock overlay -->
  <div id="unlockOverlay">
    <div class="card">
      <div style="font-weight:700;margin-bottom:10px">音声を有効化してください</div>
      <div style="opacity:.85;margin-bottom:12px">最初に画面をタップ（または下のボタン）してブラウザのオーディオを許可します。</div>
      <button id="unlock">🎵 Audioを有効化（タップ）</button>
    </div>
  </div>

<script>
(() => {
  // ===== Helpers =====
  const onReady = (fn) => { if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn, { once: true }); };
  const appendLog = (...args) => {
    const pre = document.getElementById('diaglog');
    if (!pre) return;
    const line = args.map(a => (typeof a === 'string' ? a : (()=>{ try { return JSON.stringify(a); } catch { return String(a); } })())).join(' ');
    pre.appendChild(document.createTextNode('\\n' + line)); // ← 改行は明示リテラル
  };
  const log = (...args) => { try { console.log('[Metronome]', ...args); } catch(_){} appendLog(...args); };
  const el = (id) => { const n = document.getElementById(id); if (!n) throw new Error('Missing #' + id); return n; };

  // ===== Audio & State =====
  let ctx, master;
  let bpm=100, beats=4, beatUnit=4, subdiv='eighth';
  let playing=false, step=0, nextTime=0;
  const schedAhead=0.14;

  function initAudio(){
    if (ctx) return ctx;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = parseFloat(el('volume').value||'0.7');
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.setValueAtTime(-12, ctx.currentTime);
    comp.knee.setValueAtTime(30, ctx.currentTime);
    comp.ratio.setValueAtTime(4, ctx.currentTime);
    comp.attack.setValueAtTime(0.003, ctx.currentTime);
    comp.release.setValueAtTime(0.25, ctx.currentTime);
    master.connect(comp).connect(ctx.destination);
    return ctx;
  }

  async function unlockAudio(){
    initAudio();
    try { if (ctx.state === 'suspended') await ctx.resume(); } catch(e){}
    try { const s = ctx.createBufferSource(); const b = ctx.createBuffer(1,1,ctx.sampleRate); s.buffer=b; s.connect(master); s.start(0); } catch(e) {}
    const ov = document.getElementById('unlockOverlay'); if (ctx.state==='running' && ov) ov.style.display='none';
    log('unlock:', ctx && ctx.state);
  }

  function computeSecPerStep(_bpm,_beatUnit,_subdiv){
    const spb = 60 / _bpm; // seconds per beat where beat = note of denominator
    const stepsPerBeat = _subdiv==='quarter'?1:_subdiv==='eighth'?2:_subdiv==='triplet'?3:4;
    return spb * (4/_beatUnit) / stepsPerBeat;
  }

  // ===== Instruments =====
  function playKick(t){ const osc = ctx.createOscillator(); const g = ctx.createGain(); osc.frequency.setValueAtTime(150,t); osc.frequency.exponentialRampToValueAtTime(50,t+0.1); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.3); osc.connect(g).connect(master); osc.start(t); osc.stop(t+0.3); }
  function playSnare(t){ const n=ctx.createBufferSource(); const b=ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=Math.random()*2-1; } n.buffer=b; const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=1500; const g=ctx.createGain(); g.gain.setValueAtTime(1,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.2); n.connect(f).connect(g).connect(master); n.start(t); n.stop(t+0.2); }
  function playHihat(t){ const n=ctx.createBufferSource(); const b=ctx.createBuffer(1, ctx.sampleRate*0.04, ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=Math.random()*2-1; } n.buffer=b; const f=ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=7000; const g=ctx.createGain(); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.05); n.connect(f).connect(g).connect(master); n.start(t); n.stop(t+0.05); }

  // Tambourine: multiple bright grains for distinct character
  function playTamb(t){
    const grains = 4;
    for (let k = 0; k < grains; k++) {
      const delay = (k === 0 ? 0 : (0.010 + Math.random()*0.020) * k);
      const n = ctx.createBufferSource();
      const len = (ctx.sampleRate * 0.022) | 0;
      const b = ctx.createBuffer(1, len, ctx.sampleRate);
      const d = b.getChannelData(0);
      for (let i = 0; i < d.length; i++) d[i] = (Math.random()*2 - 1) * Math.exp(-i / (len * 0.6));
      n.buffer = b;
      const bp1 = ctx.createBiquadFilter(); bp1.type='bandpass'; bp1.frequency.value = 7500 + Math.random()*2000; bp1.Q.value = 8;
      const bp2 = ctx.createBiquadFilter(); bp2.type='bandpass'; bp2.frequency.value = 12000; bp2.Q.value = 3;
      const g = ctx.createGain(); g.gain.setValueAtTime(0.55, t + delay); g.gain.exponentialRampToValueAtTime(0.001, t + delay + 0.08);
      n.connect(bp1).connect(bp2).connect(g).connect(master);
      n.start(t + delay); n.stop(t + delay + 0.09);
    }
  }

  function playShaker(t){ const n=ctx.createBufferSource(); const len=(ctx.sampleRate*0.05)|0; const b=ctx.createBuffer(1,len,ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=Math.random()*2-1; } n.buffer=b; const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=3000; bp.Q.value=1.2; const g=ctx.createGain(); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.06); n.connect(bp).connect(g).connect(master); n.start(t); n.stop(t+0.07); }
  function playConga(t){ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(400,t); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2); o.connect(g).connect(master); o.start(t); o.stop(t+0.2); }
  function playBongo(t){ const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.setValueAtTime(600,t); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.15); o.connect(g).connect(master); o.start(t); o.stop(t+0.15); }

  // ===== Scheduler =====
  function scheduleStep(i,t){
    const stepsPerBeat = subdiv==='quarter'?1:subdiv==='eighth'?2:subdiv==='triplet'?3:4;
    const beatIndex = Math.floor(i/stepsPerBeat);
    const stepInBeat = i % stepsPerBeat; const beatInBar = beatIndex % beats;
    if(el('kick').checked && stepInBeat===0) playKick(t);
    if(el('snare').checked && stepInBeat===0 && (beatInBar%2===1)) playSnare(t);
    if(el('hihat').checked) playHihat(t);
    if(el('tamb').checked) playTamb(t);
    if(el('shaker').checked) playShaker(t);
    if(el('conga').checked && stepInBeat===0 && beatInBar%2===0) playConga(t);
    if(el('bongo').checked){ const perBeat=2; const eighth=(stepInBeat*perBeat)/stepsPerBeat; if(Number.isInteger(eighth) && (eighth%2===1)) playBongo(t); }
  }

  function scheduler(){ while(nextTime < ctx.currentTime + schedAhead){ scheduleStep(step, nextTime); nextTime += computeSecPerStep(bpm, beatUnit, subdiv); step++; } }

  async function play(){
    await unlockAudio();
    bpm = parseInt(el('bpm').value||'100',10);
    beats = parseInt(el('beats').value||'4',10);
    beatUnit = parseInt(el('beatUnit').value||'4',10);
    subdiv = (el('subdiv').value||'eighth');
    playing=true; step=0; nextTime=ctx.currentTime+0.05;
    (function tick(){ if(!playing) return; scheduler(); requestAnimationFrame(tick); })();
  }
  function stop(){ playing=false; }

  onReady(()=>{
    // Wire controls
    document.getElementById('unlock')?.addEventListener('click', unlockAudio);
    el('start').addEventListener('click', play);
    el('stop').addEventListener('click', stop);
    el('volume').addEventListener('input', (e)=>{ if(master) master.gain.value=parseFloat(e.target.value||'0.7'); });
    document.getElementById('bpmMinus').addEventListener('click', ()=>{ const v=Math.max(20, parseInt(el('bpm').value||'100',10)-1); el('bpm').value=v; });
    document.getElementById('bpmPlus').addEventListener('click', ()=>{ const v=Math.min(300, parseInt(el('bpm').value||'100',10)+1); el('bpm').value=v; });

    // Gesture unlock fallback (iOS)
    document.addEventListener('pointerdown', ()=>{ if(!ctx || ctx.state!=='running'){ unlockAudio(); } }, { once:true });
    document.addEventListener('visibilitychange', ()=>{ if(ctx && document.visibilityState==='visible' && ctx.state==='suspended'){ ctx.resume(); } });

    // ===== Self‑tests =====
    const results = [];
    const pass = (name)=> results.push('PASS  ' + name);
    const fail = (name, extra='')=> results.push('FAIL  ' + name + (extra? ' — ' + extra : ''));

    try {
      const required = ['bpm','beats','beatUnit','subdiv','start','stop','unlock','volume','kick','snare','hihat'];
      const ok = required.every(id => !!document.getElementById(id));
      ok ? pass('DOM elements present: ' + required.join(', ')) : fail('DOM elements missing', required.filter(id=>!document.getElementById(id)).join(', '));
    } catch(e){ fail('DOM presence check', e.message); }

    try {
      const s1 = computeSecPerStep(120,4,'eighth');
      const s2 = computeSecPerStep(60,4,'quarter');
      const s3 = computeSecPerStep(90,8,'sixteenth');
      Math.abs(s1-0.25)<1e-6 ? pass('secPerStep(120,4,eighth)=0.25s') : fail('secPerStep case1', 'got '+s1);
      Math.abs(s2-1.0)<1e-6 ? pass('secPerStep(60,4,quarter)=1.0s') : fail('secPerStep case2', 'got '+s2);
      Math.abs(s3-(60/90*(4/8)/4))<1e-6 ? pass('secPerStep(90,8,sixteenth) math ok') : fail('secPerStep case3', 'got '+s3);
    } catch(e){ fail('Timing math', e.message); }

    try { initAudio(); pass('AudioContext created (no resume)'); } catch(e){ fail('AudioContext init', e.message); }

    try { log('TEST', { a:1 }); pass('log basic works'); } catch(e){ fail('log basic failed', e.message); }
    try { const circular={}; circular.self=circular; log('circular', circular); pass('log circular fallback works'); } catch(e){ fail('log circular', e.message); }

    const pre = document.getElementById('diaglog');
    if (pre) pre.textContent = (pre.textContent||'') + '\\n' + results.join('\\n');  // ← 改行は明示リテラル
  });
})();
</script>
</body>
</html>
