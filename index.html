<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metronome Studio v3 — Fixed (Autoplay‑safe)</title>
<style>
  body { font-family: sans-serif; background: #111; color: #fff; text-align: center; margin: 0; }
  h1 { padding: 20px 0; }
  .controls { max-width: 500px; margin: auto; background: #222; padding: 20px; border-radius: 10px; }
  .label { margin-top: 15px; }
  input[type=range], select { width: 100%; margin: 5px 0; }
  button { margin: 5px; padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
  .start { background: #4caf50; color: #fff; }
  .stop { background: #f44336; color: #fff; }
  .note { color: #fdd835; font-size: 14px; margin-top: 10px; }
</style>
</head>
<body>
<h1>Metronome Studio v3</h1>
<div class="controls">
  <div class="label">BPM: <span id="bpmVal">120</span></div>
  <input type="range" id="bpm" min="30" max="300" value="120">
  <div class="label">拍子</div>
  <select id="beatsPerMeasure">
    <option value="2">2/4</option>
    <option value="3">3/4</option>
    <option value="4" selected>4/4</option>
    <option value="6">6/8</option>
  </select>
  <div class="label">音量</div>
  <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
  <div>
    <button id="startBtn" class="start">Start</button>
    <button id="stopBtn" class="stop">Stop</button>
  </div>
  <div class="note">※マナーモードでは音は鳴りません（イヤホンや解除で鳴ります）</div>
</div>

<script>
let audioCtx;
let currentBeat = 0;
let bpm = 120;
let beatsPerMeasure = 4;
let volume = 0.5;
let intervalId;

const bpmSlider = document.getElementById('bpm');
const bpmVal = document.getElementById('bpmVal');
const beatsSelect = document.getElementById('beatsPerMeasure');
const volumeSlider = document.getElementById('volume');

bpmSlider.addEventListener('input', () => {
  bpm = parseInt(bpmSlider.value);
  bpmVal.textContent = bpm;
});
beatsSelect.addEventListener('change', () => {
  beatsPerMeasure = parseInt(beatsSelect.value);
});
volumeSlider.addEventListener('input', () => {
  volume = parseFloat(volumeSlider.value);
});

document.getElementById('startBtn').addEventListener('click', () => {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
  startMetronome();
});

document.getElementById('stopBtn').addEventListener('click', stopMetronome);

function startMetronome() {
  stopMetronome();
  const interval = (60 / bpm) * 1000;
  intervalId = setInterval(playClick, interval);
}

function stopMetronome() {
  clearInterval(intervalId);
  currentBeat = 0;
}

function playClick() {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  osc.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  gainNode.gain.value = volume;
  osc.type = 'square';
  osc.frequency.value = (currentBeat % beatsPerMeasure === 0) ? 1000 : 800;
  osc.start();
  osc.stop(audioCtx.currentTime + 0.05);
  currentBeat++;
}
</script>
</body>
</html>
