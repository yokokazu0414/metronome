<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ã‚¨ãƒŸãƒªã‚¢ãƒ”ã‚¢ãƒæ•™å®¤ ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ </title>
<style>
  :root{
    /* === ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆLPã®ä¸–ç•Œè¦³ã‚’åæ˜ ï¼šæ¸©ã‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ç³»ï¼‰ === */
    --primary: #DC7633;        /* ãƒ¡ã‚¤ãƒ³ã®ã‚ªãƒ¬ãƒ³ã‚¸ */
    --primary-strong: #C95F1D; /* å°‘ã—è½ã¡ç€ã„ãŸæ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    --primary-light: #F39C12;  /* æ˜ã‚‹ã‚ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
    --accent: #FFD9B3;         /* ã‚¯ãƒªãƒ¼ãƒ ãŒã‹ã£ãŸæ·¡ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    --warm-cream: #FFF6EA;     /* èƒŒæ™¯ãƒ™ãƒ¼ã‚¹ */
    --soft-rose: #FFEDE1;      /* è–„ã„ãƒ”ãƒ³ã‚¯ã‚ªãƒ¬ãƒ³ã‚¸å¯„ã‚Š */

    --bg-gradient: linear-gradient(135deg, var(--warm-cream) 0%, var(--soft-rose) 40%, #FFF1E6 100%);

    --panel-bg: rgba(255, 255, 255, 0.94);
    --panel-border: rgba(220, 118, 51, 0.18);
    --card-bg: rgba(255, 246, 234, 0.9);
    --card-border: rgba(220, 118, 51, 0.22);

    --text-dark: #2C1810;
    --text-medium: #5D4037;
    --text-light: #8D6E63;

    --shadow-primary: 0 8px 32px rgba(201, 95, 29, 0.12);
    --shadow-warm: 0 4px 20px rgba(220, 118, 51, 0.14);
    --shadow-soft: 0 2px 12px rgba(201, 95, 29, 0.10);
  }

  *,*::before,*::after{ box-sizing:border-box }

  html,body{
    margin:0; padding:0; width:100%; max-width:100%; overflow-x:hidden;
    background: var(--bg-gradient);
    color: var(--text-dark);
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic Medium", "Meiryo", sans-serif;
    min-height: 100vh;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .decorative-pattern {
    position: fixed; top: 0; left: 0; right: 0; height: 150px; z-index: -1;
    background:
      radial-gradient(circle at 20% 20%, rgba(220, 118, 51, 0.05) 0%, transparent 50%),
      radial-gradient(circle at 80% 40%, rgba(255, 171, 64, 0.05) 0%, transparent 50%),
      radial-gradient(circle at 40% 80%, rgba(255, 217, 179, 0.08) 0%, transparent 50%);
  }

  .app{ max-width: 390px; margin: 0 auto; padding: max(20px, env(safe-area-inset-top) + 15px) 20px calc(env(safe-area-inset-bottom) + 20px); position: relative; z-index: 1; }

  .header { text-align: center; margin-bottom: 28px; padding: 20px 0 10px; }
  .title {
    font-size: 26px; font-weight: 800; letter-spacing: 0.4px; margin: 0 0 6px 0;
    background: linear-gradient(45deg, var(--primary-strong), var(--primary-light));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    text-shadow: 0 2px 6px rgba(201, 95, 29, 0.15);
  }
  .subtitle { font-size: 17px; color: var(--text-medium); margin: 0 0 4px 0; font-weight: 700; }
  .author   { font-size: 12px; color: var(--text-light); opacity: 0.9; font-style: italic; }

  .panel{
    background: var(--panel-bg);
    backdrop-filter: blur(12px);
    border: 1.5px solid var(--panel-border);
    border-radius: 26px;
    padding: 24px 20px;
    margin: 0 auto 22px;
    box-shadow: var(--shadow-primary);
    position: relative;
    overflow: visible; /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã« */
  }
  .panel::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.7), transparent);
  }

  .section { margin: 22px 0; }
  .section:first-child { margin-top: 0; }

  .label {
    font-size: 14px; color: var(--primary-strong); margin-bottom: 12px; font-weight: 800;
    display: flex; align-items: center; gap: 8px; letter-spacing: 0.2px;
  }
  .label::before { content: 'â™ª'; color: var(--primary); font-size: 18px; filter: drop-shadow(0 1px 2px rgba(220,118,51,0.25)); }

  /* ===== BPM Section ===== */
  .bpm-section {
    text-align: center; padding: 20px 0; background: var(--card-bg);
    border-radius: 18px; border: 1px solid var(--card-border); margin: 16px 0; box-shadow: var(--shadow-soft);
  }
  .bpm-display { font-size: 50px; font-weight: 800; color: var(--primary-strong); margin: 14px 0; letter-spacing: -0.5px; text-shadow: 0 2px 6px rgba(201,95,29,0.14); }
  .bpm-controls { display: flex; justify-content: center; align-items: center; gap: 22px; margin-top: 18px; }

  .bpm-btn {
    width: 62px; height: 62px; border-radius: 50%; border: none;
    background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: #fff;
    font-size: 30px; font-weight: 800; box-shadow: var(--shadow-warm);
    transition: transform .2s ease, box-shadow .2s ease; display:flex; align-items:center; justify-content:center;
  }
  .bpm-btn:active { transform: scale(0.95); box-shadow: var(--shadow-soft); }
  .bpm-btn:hover  { filter: brightness(1.03); }

  .bpm-input {
    width: 128px; height: 54px; font-size: 26px; font-weight: 800; text-align: center;
    border: 2px solid var(--panel-border); border-radius: 16px;
    background: rgba(255, 255, 255, 0.96); color: var(--text-dark); box-shadow: inset 0 2px 4px rgba(201,95,29,0.08);
  }

  /* ===== Time Signature ===== */
  .controls-row { display: grid; grid-template-columns: 1fr; gap: 16px; margin: 20px 0; }
  .control-card { background: var(--card-bg); border: 1.5px solid var(--card-border); border-radius: 16px; padding: 16px; backdrop-filter: blur(8px); box-shadow: var(--shadow-soft); position: relative; z-index: 1; }

  .control-select{
    width: 100%; height: 44px; font-size: 16px; font-weight: 700; text-align: center;
    border: 1.5px solid var(--card-border); border-radius: 12px;
    background: rgba(255,255,255,0.96); color: var(--text-dark); box-shadow: inset 0 1px 3px rgba(201,95,29,0.06);
    padding: 0 10px;
  }

  /* ===== Volume ===== */
  .volume-section { padding: 16px; background: var(--card-bg); border-radius: 16px; border: 1.5px solid var(--card-border); box-shadow: var(--shadow-soft); }
  .volume-slider {
    width: 100%; height: 8px; border-radius: 4px; background: linear-gradient(90deg, #FFECD4, var(--primary), var(--primary-light));
    appearance: none; outline: none; margin: 12px 0; box-shadow: inset 0 1px 3px rgba(201,95,29,0.12);
  }
  .volume-slider::-webkit-slider-thumb {
    appearance: none; width: 26px; height: 26px; border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-light)); box-shadow: var(--shadow-warm); cursor: pointer; border: 2px solid white;
  }
  .volume-slider::-moz-range-thumb {
    width: 26px; height: 26px; border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-light)); box-shadow: var(--shadow-warm); cursor: pointer; border: 2px solid white;
  }

  /* ===== Kit ===== */
  .kit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 16px 0; }
  .kit-item {
    display: flex; align-items: center; gap: 12px; padding: 14px 16px;
    background: var(--card-bg); border: 1.5px solid var(--card-border); border-radius: 14px;
    cursor: pointer; transition: all .2s ease; backdrop-filter: blur(8px); box-shadow: var(--shadow-soft);
  }
  .kit-item:hover { background: rgba(255,246,234,0.98); border-color: var(--primary); transform: translateY(-1px); }
  .kit-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); border-radius: 4px; }
  .kit-item label { font-size: 15px; font-weight: 700; color: var(--text-dark); cursor: pointer; flex: 1; }

  /* ===== Play Buttons ===== */
  .play-controls { display: flex; gap: 16px; justify-content: center; margin-top: 30px; padding: 10px 0; }
  .play-btn {
    flex: 1; max-width: 150px; height: 56px; border: none; border-radius: 28px; font-size: 18px; font-weight: 800; cursor: pointer;
    transition: all .2s ease; box-shadow: var(--shadow-warm); letter-spacing: 0.3px;
  }
  .play-btn.start { background: linear-gradient(135deg, #27AE60, #2ECC71); color: #fff; }
  .play-btn.stop  { background: linear-gradient(135deg, #E74C3C, #C0392B); color: #fff; }
  .play-btn:active { transform: scale(0.97); }
  .play-btn:hover  { box-shadow: var(--shadow-primary); transform: translateY(-1px); }

  .divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(220,118,51,0.28), transparent); margin: 24px 0; }

  /* ===== æ‹é ­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ ===== */
  .indicator {
    display:flex; justify-content:center; gap:10px; margin-top:10px;
  }
  .dot {
    width:14px; height:14px; border-radius:50%;
    background: rgba(0,0,0,0.1);
    border: 2px solid rgba(220,118,51,0.35);
    box-shadow: 0 2px 5px rgba(201,95,29,0.12) inset;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .dot.strong { width:16px; height:16px; }
  .dot.active {
    background: var(--primary);
    border-color: var(--primary-strong);
    transform: scale(1.15);
  }

  /* Unlock overlay */
  #unlockOverlay {
    position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
    background: rgba(255, 246, 234, 0.96); backdrop-filter: blur(12px); z-index: 9999; padding: 20px; transition: opacity 0.4s ease;
  }
  #unlockOverlay.hidden { opacity: 0; pointer-events: none; }
  .unlock-card {
    background: var(--panel-bg); border: 1.5px solid var(--panel-border); border-radius: 24px;
    padding: 30px 24px; text-align: center; max-width: 340px; box-shadow: var(--shadow-primary);
  }
  .unlock-title   { font-size: 20px; font-weight: 800; color: var(--primary-strong); margin-bottom: 12px; }
  .unlock-message { font-size: 16px; color: var(--text-medium); margin-bottom: 22px; line-height: 1.6; }
  #unlock {
    width: 100%; height: 56px; border: none; border-radius: 28px;
    background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: #fff;
    font-size: 18px; font-weight: 800; cursor: pointer; box-shadow: var(--shadow-warm); transition: all .2s ease;
  }
  #unlock:active { transform: scale(0.97); }
  #unlock:hover  { filter: brightness(1.03); }

  @media (max-width: 375px) {
    .app { padding-left: 16px; padding-right: 16px; }
    .bpm-display { font-size: 46px; }
    .controls-row { gap: 12px; }
    .kit-grid { grid-template-columns: 1fr; }
    .bpm-controls { gap: 18px; }
    .bpm-btn { width: 56px; height: 56px; font-size: 26px; }
  }

  input:focus, select:focus, button:focus { outline: 2px solid var(--primary); outline-offset: 2px; }
</style>
</head>
<body>
  <div class="decorative-pattern"></div>

  <!-- Unlock overlay -->
  <div id="unlockOverlay">
    <div class="unlock-card">
      <div class="unlock-title">ğŸµ éŸ³å£°ã‚’æœ‰åŠ¹åŒ–</div>
      <div class="unlock-message">ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã«<br>ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„</div>
      <button id="unlock">ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</button>
    </div>
  </div>

  <div class="app">
    <div class="header">
      <h1 class="title">ã‚¨ãƒŸãƒªã‚¢ãƒ”ã‚¢ãƒæ•™å®¤</h1>
      <div class="subtitle">ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ </div>
      <div class="author">Created by æ–°ç”°ãƒŠã‚ªãƒŸ</div>
    </div>

    <div class="panel">
      <!-- BPM Section -->
      <div class="section bpm-section">
        <div class="label">ãƒ†ãƒ³ãƒè¨­å®š</div>
        <div class="bpm-section">
          <div class="bpm-display" id="bpmDisplay">100</div>
          <div class="bpm-controls">
            <button id="bpmMinus" class="bpm-btn" aria-label="BPMã‚’ä¸‹ã’ã‚‹">âˆ’</button>
            <input id="bpm" class="bpm-input" type="number" value="100" min="20" max="300" />
            <button id="bpmPlus" class="bpm-btn" aria-label="BPMã‚’ä¸Šã’ã‚‹">ï¼‹</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Time signature (fixed choices) -->
      <div class="section">
        <div class="label">æ‹å­</div>
        <div class="controls-row">
          <div class="control-card" style="z-index:2">
            <select id="timeSig" class="control-select" aria-label="æ‹å­è¨˜å·">
              <option value="2/4">2/4</option>
              <option value="3/4">3/4</option>
              <option value="4/4" selected>4/4</option>
              <option value="3/8">3/8</option>
              <option value="6/8">6/8</option>
            </select>
            <!-- æ‹é ­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div id="beatIndicator" class="indicator" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <!-- Volume -->
      <div class="section">
        <div class="label">éŸ³é‡èª¿æ•´</div>
        <div class="volume-section">
          <input id="volume" class="volume-slider" type="range" min="0" max="1" step="0.01" value="0.7">
        </div>
      </div>

      <div class="divider"></div>

      <!-- Kit -->
      <div class="section">
        <div class="label">æ¥½å™¨ã®é¸æŠ</div>
        <div class="kit-grid">
          <div class="kit-item"><input type="checkbox" id="kick" checked><label for="kick">ã‚­ãƒƒã‚¯</label></div>
          <div class="kit-item"><input type="checkbox" id="snare" checked><label for="snare">ã‚¹ãƒã‚¢</label></div>
          <div class="kit-item"><input type="checkbox" id="hihat" checked><label for="hihat">ãƒã‚¤ãƒãƒƒãƒˆ</label></div>
          <div class="kit-item"><input type="checkbox" id="tamb"><label for="tamb">ã‚¿ãƒ³ãƒãƒªãƒ³</label></div>
          <div class="kit-item"><input type="checkbox" id="shaker"><label for="shaker">ã‚·ã‚§ã‚¤ã‚«ãƒ¼</label></div>
          <div class="kit-item"><input type="checkbox" id="conga"><label for="conga">ã‚³ãƒ³ã‚¬</label></div>
        </div>
      </div>

      <div class="play-controls">
        <button id="start" class="play-btn start">â–¶ é–‹å§‹</button>
        <button id="stop" class="play-btn stop">â¸ åœæ­¢</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  // === é›†ä¸­è¨­å®š ===================================================
  const CONFIG = {
    defaultBpm: 100,
    defaultTimeSig: '4/4',
    scheduleAheadSec: 0.14,
    stepsPerBeat: 2 // ç´°åˆ†UIã‚’å»ƒæ­¢ â†’ å¸¸ã«8åˆ†ãƒ•ã‚£ãƒ¼ãƒ«ï¼ˆãƒ€ã‚¦ãƒ³/è£ï¼‰
  };
  const LEVELS = {
    hihatDown: 0.75,
    hihatUp:   0.50,
    kickStrong: 1.00,
    kickWeak:   0.90,
    snareBeat2: 0.95,
    snareBeat4: 0.90,
    tambBarHead: 0.75,
    shakerBeatHead: 0.50,
    congaOn13: 0.60
  };

  let ctx, master;
  function initAudio(){
    if (ctx) return ctx;
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain();
    master.gain.value = parseFloat(el('volume').value||'0.7');
    master.connect(ctx.destination);
    return ctx;
  }
  function unlockAudioNow(){
    initAudio();
    try{ ctx.resume(); }catch(e){}
    try{ const s=ctx.createBufferSource(); s.buffer=ctx.createBuffer(1,1,ctx.sampleRate); s.connect(master); s.start(0);}catch(e){}
    const ov = el('unlockOverlay'); if (ctx && ctx.state==='running' && ov) ov.classList.add('hidden');
  }

  // ==== éŸ³è‰² =====================================================
  function playKick(t, vol=1){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(160,t);
    o.frequency.exponentialRampToValueAtTime(55,t+0.10);
    g.gain.setValueAtTime(1.0*vol,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.28);
    o.connect(g).connect(master); o.start(t); o.stop(t+0.32);
  }
  function playSnare(t, vol=1){
    const tone=ctx.createOscillator(), tg=ctx.createGain();
    tone.type='triangle';
    tone.frequency.setValueAtTime(190,t);
    tg.gain.setValueAtTime(0.25*vol,t);
    tg.gain.exponentialRampToValueAtTime(0.001,t+0.14);
    const n=ctx.createBufferSource(), b=ctx.createBuffer(1, ctx.sampleRate*0.20, ctx.sampleRate);
    const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
    n.buffer=b; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800;
    const ng=ctx.createGain(); ng.gain.setValueAtTime(0.8*vol,t); ng.gain.exponentialRampToValueAtTime(0.001,t+0.20);
    tone.connect(tg).connect(master);
    n.connect(hp).connect(ng).connect(master);
    tone.start(t); tone.stop(t+0.18);
    n.start(t); n.stop(t+0.2);
  }
  function playHihat(t, vol=1){
    const n=ctx.createBufferSource(); const b=ctx.createBuffer(1, ctx.sampleRate*0.04, ctx.sampleRate);
    const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
    n.buffer=b; const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000;
    const g=ctx.createGain(); g.gain.setValueAtTime(0.6*vol,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.05);
    n.connect(hp).connect(g).connect(master); n.start(t); n.stop(t+0.05);
  }
  function playTamb(t, vol=1){
    const n=ctx.createBufferSource(); 
    const b=ctx.createBuffer(1, ctx.sampleRate*0.15, ctx.sampleRate);
    const d=b.getChannelData(0); 
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1) * Math.sin(i*0.02) * 0.3;
    n.buffer=b;
    const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000;
    const g=ctx.createGain(); g.gain.setValueAtTime(0.55*vol,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.15);
    n.connect(hp).connect(g).connect(master); n.start(t); n.stop(t+0.15);
  }
  function playShaker(t, vol=1){
    const n=ctx.createBufferSource();
    const len=(ctx.sampleRate*0.06)|0;
    const b=ctx.createBuffer(1,len,ctx.sampleRate);
    const d=b.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1) * Math.exp(-i/(len*0.55));
    n.buffer=b;
    const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2800; bp.Q.value=1.2;
    const g=ctx.createGain(); g.gain.setValueAtTime(0.45*vol,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.07);
    n.connect(bp).connect(g).connect(master);
    n.start(t); n.stop(t+0.08);
  }
  function playConga(t, vol=1){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine';
    o.frequency.setValueAtTime(420,t);
    o.frequency.exponentialRampToValueAtTime(300,t+0.06);
    g.gain.setValueAtTime(0.55*vol,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.18);
    o.connect(g).connect(master);
    o.start(t); o.stop(t+0.2);
  }

  // ==== ãƒˆãƒ©ãƒ³ã‚¹ãƒãƒ¼ãƒˆï¼çŠ¶æ…‹ =====================================
  let bpmVal = CONFIG.defaultBpm;
  let beats = 4, beatUnit = 4;
  let playing=false, step=0, nextTime=0;
  const ahead = CONFIG.scheduleAheadSec;

  function secPerStep(){
    const spb = 60 / bpmVal;
    return spb * (4/beatUnit) / CONFIG.stepsPerBeat;
  }
  function secPerBeat(){
    const spb = 60 / bpmVal;
    return spb * (4/beatUnit);
  }

  // ==== ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ ===========================================
  function buildIndicator(){
    const cont = el('beatIndicator');
    cont.innerHTML = '';
    for(let i=0;i<beats;i++){
      const d = document.createElement('span');
      d.className = 'dot';
      if(i===0) d.classList.add('strong'); // 1æ‹ç›®ã¯å¼·æ‹è¡¨ç¤º
      cont.appendChild(d);
    }
  }
  let lastActiveDot = -1;
  function updateIndicator(beatInBar){
    const cont = el('beatIndicator');
    const dots = cont.children;
    if(!dots || !dots.length) return;
    if(lastActiveDot>=0 && lastActiveDot<dots.length) dots[lastActiveDot].classList.remove('active');
    if(beatInBar>=0 && beatInBar<dots.length) dots[beatInBar].classList.add('active');
    lastActiveDot = beatInBar;
  }

  // ==== ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ© =============================================
  function scheduleStep(i, t){
    const stepsPerBeat = CONFIG.stepsPerBeat; // 8åˆ†ãƒ•ã‚£ãƒ¼ãƒ«å›ºå®š
    const beatIndex = Math.floor(i/stepsPerBeat);
    const stepInBeat = i % stepsPerBeat;
    const beatInBar  = beatIndex % beats;

    // Hi-Hatï¼š8åˆ†ï¼ˆãƒ€ã‚¦ãƒ³/è£ï¼‰
    if (el('hihat').checked){
      const hhLevel = (stepInBeat===0) ? LEVELS.hihatDown : LEVELS.hihatUp;
      playHihat(t, hhLevel);
    }

    // æ‹é ­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
    if(stepInBeat===0){ updateIndicator(beatInBar); }

    if (stepInBeat===0){
      // Snare ãƒ‘ã‚¿ãƒ¼ãƒ³
      if (el('snare').checked){
        if (beats===4 && beatUnit===4){
          // 4/4ï¼š2æ‹ç›®ãƒ»4æ‹ç›®
          if (beatInBar===1 || beatInBar===3){
            playSnare(t, beatInBar===1 ? LEVELS.snareBeat2 : LEVELS.snareBeat4);
          }
        } else if (beats===2 && beatUnit===4){
          // 2/4ï¼š1æ‹ç›®ã¯ä¼‘ã¿ã€2æ‹ç›®ã®ã¿
          if (beatInBar===1){
            playSnare(t, LEVELS.snareBeat2);
          }
        }
        // ä»–ã®æ‹å­ã¯å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µå¯ï¼ˆç¾çŠ¶ã¯ã‚¹ãƒã‚¢ç„¡ã—ï¼‰
      }

      // Kick ãƒ‘ã‚¿ãƒ¼ãƒ³
      if (el('kick').checked){
        if (beats===4 && beatUnit===4){
          // 4/4ï¼š1æ‹ç›®ï¼å˜ç™º / 3æ‹ç›®ï¼ãƒ€ãƒ–ãƒ«
          if (beatInBar === 0){
            playKick(t, LEVELS.kickStrong);
          } else if (beatInBar === 2){
            const second = t + secPerBeat() * 0.50; // åŠæ‹å¾Œï¼ˆ8åˆ†ï¼‰
            playKick(t, LEVELS.kickWeak + 0.05);
            playKick(second, 0.75);
          }
        } else {
          // ãã‚Œä»¥å¤–ã®æ‹å­ï¼šå„æ‹é ­ã‚’è»½ãæ”¯ãˆã‚‹
          playKick(t, 0.70);
        }
      }

      // Tamb, Shaker, Conga
      if (el('tamb').checked && beatInBar===0){ playTamb(t, LEVELS.tambBarHead); }
      if (el('shaker').checked){ playShaker(t, LEVELS.shakerBeatHead); }
      if (el('conga').checked){
        if(beats===4 && beatUnit===4){
          if(beatInBar===0 || beatInBar===2){ playConga(t, LEVELS.congaOn13); }
        }else{
          playConga(t, 0.55);
        }
      }
    }
  }

  function scheduler(){
    while(nextTime < ctx.currentTime + ahead){
      scheduleStep(step, nextTime);
      nextTime += secPerStep();
      step++;
    }
    if (playing) requestAnimationFrame(scheduler);
  }

  function updateBpmDisplay(){ el('bpmDisplay').textContent = el('bpm').value; }

  function start(){
    if (!ctx || ctx.state!=='running') unlockAudioNow();
    bpmVal = parseInt(el('bpm').value||String(CONFIG.defaultBpm),10);
    const [b,u] = el('timeSig').value.split('/').map(n=>parseInt(n,10));
    beats=b; beatUnit=u;
    buildIndicator(); // æ‹æ•°ãŒå¤‰ã‚ã‚‹ã®ã§å†æ§‹ç¯‰
    playing=true; step=0; nextTime=ctx.currentTime+0.05;
    scheduler();
  }
  function stop(){ playing=false; }

  // === æ°¸ç¶šåŒ– ====================================================
  function persist(){
    localStorage.setItem('metroSettings', JSON.stringify({
      bpm: el('bpm').value,
      timeSig: el('timeSig').value,
      volume: el('volume').value,
      kits: {
        kick: el('kick').checked, snare: el('snare').checked, hihat: el('hihat').checked,
        tamb: el('tamb').checked, shaker: el('shaker').checked, conga: el('conga').checked
      }
    }));
  }
  function restore(){
    try{
      const s = JSON.parse(localStorage.getItem('metroSettings')||'{}');
      if(s.bpm) el('bpm').value = s.bpm;
      const tsSel = el('timeSig');
      if(s.timeSig && [...tsSel.options].some(o=>o.value===s.timeSig)){
        tsSel.value = s.timeSig;
      } else {
        tsSel.value = CONFIG.defaultTimeSig;
      }
      if(s.volume){ el('volume').value = s.volume; if(master) master.gain.value = +s.volume; }
      if(s.kits){ for(const k in s.kits){ const c = el(k); if(c) c.checked = !!s.kits[k]; } }
      updateBpmDisplay();
      const [b,u] = tsSel.value.split('/').map(n=>parseInt(n,10));
      beats=b; beatUnit=u;
      buildIndicator();
      updateIndicator(-1);
    }catch(e){}
  }

  // === ã‚¤ãƒ™ãƒ³ãƒˆ ===================================================
  const unlockBtn = el('unlock');
  if (unlockBtn){
    unlockBtn.addEventListener('click', unlockAudioNow, {passive:false});
    unlockBtn.addEventListener('touchend', unlockAudioNow, {passive:false});
  }
  document.addEventListener('pointerdown', ()=>{ if(!ctx || ctx.state!=='running') unlockAudioNow(); }, {passive:false});

  el('start').addEventListener('click', start, {passive:false});
  el('stop').addEventListener('click', stop, {passive:false});

  el('bpmMinus').addEventListener('click', ()=>{ el('bpm').value = Math.max(20, parseInt(el('bpm').value||'100',10)-1); updateBpmDisplay(); persist(); }, {passive:false});
  el('bpmPlus').addEventListener('click',  ()=>{ el('bpm').value = Math.min(300, parseInt(el('bpm').value||'100',10)+1); updateBpmDisplay(); persist(); }, {passive:false});
  el('bpm').addEventListener('input', ()=>{ updateBpmDisplay(); persist(); });

  ['timeSig','volume','kick','snare','hihat','tamb','shaker','conga'].forEach(id=>{
    const node = el(id); if(!node) return;
    const ev = (node.type==='checkbox') ? 'change' : (node.type==='range' ? 'input' : 'change');
    node.addEventListener(ev, ()=>{ 
      if(id==='timeSig'){ 
        const [b,u] = node.value.split('/').map(n=>parseInt(n,10));
        beats=b; beatUnit=u; buildIndicator(); updateIndicator(-1);
      }
      if(id==='volume'){ if(master) master.gain.value = parseFloat(node.value||'0.7'); }
      persist();
    }, {passive:true});
  });

  // åˆæœŸè¡¨ç¤º
  updateBpmDisplay();
  restore();
})();
</script>
</body>
</html>
